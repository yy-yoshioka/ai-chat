{"version":3,"names":["prisma_1","cov_23f3ci9red","s","require","widgetKey_1","requireValidWidget","req","res","next","f","widgetKey","b","params","body","headers","status","json","error","isValidWidgetKey","widget","prisma","findUnique","where","include","company","select","id","name","plan","isActive","companyId","accentColor","logoUrl","console","exports"],"sources":["/Users/yusukeyoshioka/projects/youtube/ai-chat/ai-chat-api/src/middleware/requireValidWidget.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\nimport { prisma } from '../lib/prisma';\nimport { isValidWidgetKey } from '../utils/widgetKey';\n\nexport interface WidgetRequest extends Request {\n  widget?: {\n    id: string;\n    widgetKey: string;\n    name: string;\n    companyId: string;\n    isActive: boolean;\n    accentColor: string;\n    logoUrl: string | null;\n  };\n}\n\n/**\n * Middleware to validate widget key and attach widget to request\n */\nexport async function requireValidWidget(\n  req: WidgetRequest,\n  res: Response,\n  next: NextFunction\n): Promise<void> {\n  try {\n    const widgetKey =\n      req.params.widgetKey || req.body.widgetKey || req.headers['x-widget-key'];\n\n    if (!widgetKey) {\n      res.status(400).json({ error: 'Widget key is required' });\n      return;\n    }\n\n    if (!isValidWidgetKey(widgetKey)) {\n      res.status(400).json({ error: 'Invalid widget key format' });\n      return;\n    }\n\n    const widget = await prisma.widget.findUnique({\n      where: { widgetKey },\n      include: {\n        company: {\n          select: {\n            id: true,\n            name: true,\n            plan: true,\n          },\n        },\n      },\n    });\n\n    if (!widget) {\n      res.status(404).json({ error: 'Widget not found' });\n      return;\n    }\n\n    if (!widget.isActive) {\n      res.status(403).json({ error: 'Widget is inactive' });\n      return;\n    }\n\n    // Attach widget info to request\n    req.widget = {\n      id: widget.id,\n      widgetKey: widget.widgetKey,\n      name: widget.name,\n      companyId: widget.companyId,\n      isActive: widget.isActive,\n      accentColor: widget.accentColor,\n      logoUrl: widget.logoUrl,\n    };\n\n    next();\n  } catch (error) {\n    console.error('Widget validation error:', error);\n    res.status(500).json({ error: 'Internal server error' });\n  }\n}\n"],"mappings":"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","ignoreList":[]}