98cbe31a0e8c6af1dbcadeb6cc9bfc11
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const jwt_1 = require("../../../src/utils/jwt");
describe('JWT Utils', () => {
    let mockResponse;
    beforeEach(() => {
        mockResponse = {
            cookie: jest.fn(),
        };
    });
    describe('signToken', () => {
        it('should sign a token and set cookie', () => {
            const user = { id: '123', email: 'test@example.com', isAdmin: false };
            const token = (0, jwt_1.signToken)(user, mockResponse);
            expect(token).toBeDefined();
            expect(mockResponse.cookie).toHaveBeenCalledWith('token', token, expect.objectContaining({
                httpOnly: true,
                maxAge: 7 * 24 * 60 * 60 * 1000,
                secure: false, // NODE_ENV is test
                sameSite: 'lax',
            }));
        });
        it('should set secure cookie in production', () => {
            const originalEnv = process.env.NODE_ENV;
            process.env.NODE_ENV = 'production';
            const user = { id: '123', email: 'test@example.com' };
            (0, jwt_1.signToken)(user, mockResponse);
            expect(mockResponse.cookie).toHaveBeenCalledWith('token', expect.any(String), expect.objectContaining({
                secure: true,
                sameSite: 'strict',
            }));
            process.env.NODE_ENV = originalEnv;
        });
        it('should throw error if JWT_SECRET is not defined', () => {
            const originalSecret = process.env.JWT_SECRET;
            delete process.env.JWT_SECRET;
            expect(() => {
                (0, jwt_1.signToken)({ id: '123', email: 'test@example.com' }, mockResponse);
            }).toThrow('JWT_SECRET is not defined');
            process.env.JWT_SECRET = originalSecret;
        });
    });
    describe('verifyToken', () => {
        it('should verify a valid token', () => {
            const payload = { id: '123', email: 'test@example.com' };
            const token = jsonwebtoken_1.default.sign(payload, process.env.JWT_SECRET);
            const decoded = (0, jwt_1.verifyToken)(token);
            expect(decoded.id).toBe(payload.id);
            expect(decoded.email).toBe(payload.email);
        });
        it('should throw error for invalid token', () => {
            expect(() => {
                (0, jwt_1.verifyToken)('invalid-token');
            }).toThrow('Invalid token');
        });
        it('should throw error for expired token', () => {
            const token = jsonwebtoken_1.default.sign({ id: '123', email: 'test@example.com' }, process.env.JWT_SECRET, { expiresIn: '-1s' });
            expect(() => {
                (0, jwt_1.verifyToken)(token);
            }).toThrow('Invalid token');
        });
        it('should throw error if JWT_SECRET is not defined', () => {
            const originalSecret = process.env.JWT_SECRET;
            delete process.env.JWT_SECRET;
            expect(() => {
                (0, jwt_1.verifyToken)('some-token');
            }).toThrow('JWT_SECRET is not defined');
            process.env.JWT_SECRET = originalSecret;
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3l1c3VrZXlvc2hpb2thL3Byb2plY3RzL3lvdXR1YmUvYWktY2hhdC9haS1jaGF0LWFwaS90ZXN0cy91bml0L3V0aWxzL2p3dC50ZXN0LnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsZ0VBQStCO0FBRS9CLGdEQUFnRTtBQUVoRSxRQUFRLENBQUMsV0FBVyxFQUFFLEdBQUcsRUFBRTtJQUN6QixJQUFJLFlBQStCLENBQUM7SUFFcEMsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLFlBQVksR0FBRztZQUNiLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ2xCLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxXQUFXLEVBQUUsR0FBRyxFQUFFO1FBQ3pCLEVBQUUsQ0FBQyxvQ0FBb0MsRUFBRSxHQUFHLEVBQUU7WUFDNUMsTUFBTSxJQUFJLEdBQUcsRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxrQkFBa0IsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUM7WUFFdEUsTUFBTSxLQUFLLEdBQUcsSUFBQSxlQUFTLEVBQUMsSUFBSSxFQUFFLFlBQXdCLENBQUMsQ0FBQztZQUV4RCxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDNUIsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxvQkFBb0IsQ0FDOUMsT0FBTyxFQUNQLEtBQUssRUFDTCxNQUFNLENBQUMsZ0JBQWdCLENBQUM7Z0JBQ3RCLFFBQVEsRUFBRSxJQUFJO2dCQUNkLE1BQU0sRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSTtnQkFDL0IsTUFBTSxFQUFFLEtBQUssRUFBRSxtQkFBbUI7Z0JBQ2xDLFFBQVEsRUFBRSxLQUFLO2FBQ2hCLENBQUMsQ0FDSCxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsd0NBQXdDLEVBQUUsR0FBRyxFQUFFO1lBQ2hELE1B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RUFBRSxDQUFDLGlEQUFpRCxFQUFFLEdBQUcsRUFBRTtZQUN6RCxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQztZQUM5QyxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDO1lBRTlCLE1BQU0sQ0FBQyxHQUFHLEVBQUU7Z0JBQ1YsSUFBQSxpQkFBVyxFQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzVCLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1lBRXhDLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLGNBQWMsQ0FBQztRQUMxQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL3l1c3VrZXlvc2hpb2thL3Byb2plY3RzL3lvdXR1YmUvYWktY2hhdC9haS1jaGF0LWFwaS90ZXN0cy91bml0L3V0aWxzL2p3dC50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJztcbmltcG9ydCB7IFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBzaWduVG9rZW4sIHZlcmlmeVRva2VuIH0gZnJvbSAnLi4vLi4vLi4vc3JjL3V0aWxzL2p3dCc7XG5cbmRlc2NyaWJlKCdKV1QgVXRpbHMnLCAoKSA9PiB7XG4gIGxldCBtb2NrUmVzcG9uc2U6IFBhcnRpYWw8UmVzcG9uc2U+O1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIG1vY2tSZXNwb25zZSA9IHtcbiAgICAgIGNvb2tpZTogamVzdC5mbigpLFxuICAgIH07XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzaWduVG9rZW4nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzaWduIGEgdG9rZW4gYW5kIHNldCBjb29raWUnLCAoKSA9PiB7XG4gICAgICBjb25zdCB1c2VyID0geyBpZDogJzEyMycsIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsIGlzQWRtaW46IGZhbHNlIH07XG5cbiAgICAgIGNvbnN0IHRva2VuID0gc2lnblRva2VuKHVzZXIsIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZSk7XG5cbiAgICAgIGV4cGVjdCh0b2tlbikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuY29va2llKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ3Rva2VuJyxcbiAgICAgICAgdG9rZW4sXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBodHRwT25seTogdHJ1ZSxcbiAgICAgICAgICBtYXhBZ2U6IDcgKiAyNCAqIDYwICogNjAgKiAxMDAwLFxuICAgICAgICAgIHNlY3VyZTogZmFsc2UsIC8vIE5PREVfRU5WIGlzIHRlc3RcbiAgICAgICAgICBzYW1lU2l0ZTogJ2xheCcsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBzZXQgc2VjdXJlIGNvb2tpZSBpbiBwcm9kdWN0aW9uJywgKCkgPT4ge1xuICAgICAgY29uc3Qgb3JpZ2luYWxFbnYgPSBwcm9jZXNzLmVudi5OT0RFX0VOVjtcbiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Byb2R1Y3Rpb24nO1xuXG4gICAgICBjb25zdCB1c2VyID0geyBpZDogJzEyMycsIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScgfTtcbiAgICAgIHNpZ25Ub2tlbih1c2VyLCBtb2NrUmVzcG9uc2UgYXMgUmVzcG9uc2UpO1xuXG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmNvb2tpZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICd0b2tlbicsXG4gICAgICAgIGV4cGVjdC5hbnkoU3RyaW5nKSxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHNlY3VyZTogdHJ1ZSxcbiAgICAgICAgICBzYW1lU2l0ZTogJ3N0cmljdCcsXG4gICAgICAgIH0pXG4gICAgICApO1xuXG4gICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9IG9yaWdpbmFsRW52O1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBlcnJvciBpZiBKV1RfU0VDUkVUIGlzIG5vdCBkZWZpbmVkJywgKCkgPT4ge1xuICAgICAgY29uc3Qgb3JpZ2luYWxTZWNyZXQgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUO1xuICAgICAgZGVsZXRlIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQ7XG5cbiAgICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICAgIHNpZ25Ub2tlbihcbiAgICAgICAgICB7IGlkOiAnMTIzJywgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyB9LFxuICAgICAgICAgIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZVxuICAgICAgICApO1xuICAgICAgfSkudG9UaHJvdygnSldUX1NFQ1JFVCBpcyBub3QgZGVmaW5lZCcpO1xuXG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gb3JpZ2luYWxTZWNyZXQ7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCd2ZXJpZnlUb2tlbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHZlcmlmeSBhIHZhbGlkIHRva2VuJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGF5bG9hZCA9IHsgaWQ6ICcxMjMnLCBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nIH07XG4gICAgICBjb25zdCB0b2tlbiA9IGp3dC5zaWduKHBheWxvYWQsIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQhKTtcblxuICAgICAgY29uc3QgZGVjb2RlZCA9IHZlcmlmeVRva2VuKHRva2VuKTtcblxuICAgICAgZXhwZWN0KGRlY29kZWQuaWQpLnRvQmUocGF5bG9hZC5pZCk7XG4gICAgICBleHBlY3QoZGVjb2RlZC5lbWFpbCkudG9CZShwYXlsb2FkLmVtYWlsKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3IgZm9yIGludmFsaWQgdG9rZW4nLCAoKSA9PiB7XG4gICAgICBleHBlY3QoKCkgPT4ge1xuICAgICAgICB2ZXJpZnlUb2tlbignaW52YWxpZC10b2tlbicpO1xuICAgICAgfSkudG9UaHJvdygnSW52YWxpZCB0b2tlbicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBlcnJvciBmb3IgZXhwaXJlZCB0b2tlbicsICgpID0+IHtcbiAgICAgIGNvbnN0IHRva2VuID0gand0LnNpZ24oXG4gICAgICAgIHsgaWQ6ICcxMjMnLCBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nIH0sXG4gICAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQhLFxuICAgICAgICB7IGV4cGlyZXNJbjogJy0xcycgfVxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KCgpID0+IHtcbiAgICAgICAgdmVyaWZ5VG9rZW4odG9rZW4pO1xuICAgICAgfSkudG9UaHJvdygnSW52YWxpZCB0b2tlbicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBlcnJvciBpZiBKV1RfU0VDUkVUIGlzIG5vdCBkZWZpbmVkJywgKCkgPT4ge1xuICAgICAgY29uc3Qgb3JpZ2luYWxTZWNyZXQgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUO1xuICAgICAgZGVsZXRlIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQ7XG5cbiAgICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICAgIHZlcmlmeVRva2VuKCdzb21lLXRva2VuJyk7XG4gICAgICB9KS50b1Rocm93KCdKV1RfU0VDUkVUIGlzIG5vdCBkZWZpbmVkJyk7XG5cbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSBvcmlnaW5hbFNlY3JldDtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==