38387ccea02c96f2487bf379c8be339f
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.mockAuthUser = void 0;
// Mock Prisma
jest.mock('../src/lib/prisma');
// Mock Redis
jest.mock('ioredis');
// Mock logger to reduce noise in tests
jest.mock('../src/lib/logger', () => ({
    logger: {
        info: jest.fn(),
        error: jest.fn(),
        warn: jest.fn(),
        debug: jest.fn(),
    },
}));
// Mock OpenAI
jest.mock('openai', () => ({
    default: jest.fn().mockImplementation(() => ({
        chat: {
            completions: {
                create: jest.fn().mockResolvedValue({
                    choices: [
                        {
                            message: {
                                content: 'Mock AI response',
                                role: 'assistant',
                            },
                        },
                    ],
                }),
            },
        },
        embeddings: {
            create: jest.fn().mockResolvedValue({
                data: [
                    {
                        embedding: new Array(1536).fill(0.1),
                    },
                ],
            }),
        },
    })),
}));
// Mock Stripe
jest.mock('stripe', () => ({
    default: jest.fn().mockImplementation(() => ({
        customers: {
            create: jest.fn().mockResolvedValue({ id: 'cus_test' }),
            retrieve: jest.fn().mockResolvedValue({ id: 'cus_test' }),
            update: jest.fn().mockResolvedValue({ id: 'cus_test' }),
        },
        prices: {
            list: jest.fn().mockResolvedValue({
                data: [
                    {
                        id: 'price_test',
                        product: 'prod_test',
                        unit_amount: 1000,
                        currency: 'usd',
                        recurring: { interval: 'month' },
                    },
                ],
            }),
        },
        subscriptions: {
            create: jest.fn().mockResolvedValue({ id: 'sub_test' }),
            retrieve: jest.fn().mockResolvedValue({ id: 'sub_test' }),
            update: jest.fn().mockResolvedValue({ id: 'sub_test' }),
            cancel: jest.fn().mockResolvedValue({ id: 'sub_test' }),
        },
        checkout: {
            sessions: {
                create: jest.fn().mockResolvedValue({
                    id: 'cs_test',
                    url: 'https://checkout.stripe.com/test',
                }),
            },
        },
        billingPortal: {
            sessions: {
                create: jest
                    .fn()
                    .mockResolvedValue({ url: 'https://billing.stripe.com/test' }),
            },
        },
        webhookEndpoints: {
            create: jest.fn().mockResolvedValue({ id: 'we_test' }),
        },
    })),
}));
// Mock SendGrid
jest.mock('@sendgrid/mail', () => ({
    setApiKey: jest.fn(),
    send: jest.fn().mockResolvedValue([{}]),
}));
// Mock Qdrant
jest.mock('@qdrant/js-client-rest', () => ({
    QdrantClient: jest.fn().mockImplementation(() => ({
        createCollection: jest.fn().mockResolvedValue(true),
        getCollection: jest.fn().mockResolvedValue({ status: 'green' }),
        upsert: jest.fn().mockResolvedValue({ operation_id: 1 }),
        search: jest.fn().mockResolvedValue({
            result: [
                {
                    id: 'vec-1',
                    score: 0.95,
                    payload: {
                        content: 'Test content',
                        metadata: {},
                    },
                },
            ],
        }),
        delete: jest.fn().mockResolvedValue({ operation_id: 1 }),
    })),
}));
// Mock AWS SDK
jest.mock('@aws-sdk/client-s3', () => ({
    S3Client: jest.fn(),
    PutObjectCommand: jest.fn(),
    GetObjectCommand: jest.fn(),
    DeleteObjectCommand: jest.fn(),
}));
// Mock Socket.IO
jest.mock('socket.io', () => {
    const mockSocket = {
        id: 'test-socket-id',
        emit: jest.fn(),
        on: jest.fn(),
        join: jest.fn(),
        leave: jest.fn(),
        disconnect: jest.fn(),
    };
    const mockIo = {
        on: jest.fn((event, handler) => {
            if (event === 'connection') {
                // Simulate a connection
                setImmediate(() => handler(mockSocket));
            }
        }),
        emit: jest.fn(),
        to: jest.fn(() => mockIo),
        in: jest.fn(() => mockIo),
        sockets: {
            sockets: new Map([[mockSocket.id, mockSocket]]),
        },
    };
    return {
        Server: jest.fn(() => mockIo),
    };
});
// Set up test environment
require("reflect-metadata");
const util_1 = require("util");
// Set environment variables for tests
process.env.NODE_ENV = 'test';
process.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/test';
process.env.JWT_SECRET = 'test-secret-key';
process.env.STRIPE_SECRET_KEY = 'sk_test_mock';
process.env.SENDGRID_API_KEY = 'SG.test-key';
process.env.QDRANT_URL = 'http://localhost:6333';
process.env.QDRANT_API_KEY = 'test-qdrant-key';
process.env.AWS_ACCESS_KEY_ID = 'test-aws-key';
process.env.AWS_SECRET_ACCESS_KEY = 'test-aws-secret';
process.env.AWS_REGION = 'us-east-1';
process.env.S3_BUCKET_NAME = 'test-bucket';
process.env.REDIS_URL = 'redis://localhost:6379';
process.env.OPENAI_API_KEY = 'sk-test-mock';
// Mock global objects
global.TextEncoder = util_1.TextEncoder;
global.TextDecoder = util_1.TextDecoder;
// Clean up after each test
afterEach(() => {
    jest.clearAllMocks();
});
// Global test timeout
jest.setTimeout(30000);
// Test helpers
exports.mockAuthUser = {
    id: 'test-user-id',
    email: 'test@example.com',
    organizationId: 'test-org-id',
    roles: ['admin'],
};
// Mock date for consistent testing
const mockDate = new Date('2024-01-01T00:00:00Z');
jest.useFakeTimers();
jest.setSystemTime(mockDate);
// Helper to reset all mocks
global.resetAllMocks = () => {
    jest.clearAllMocks();
    jest.clearAllTimers();
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3l1c3VrZXlvc2hpb2thL3Byb2plY3RzL3lvdXR1YmUvYWktY2hhdC9haS1jaGF0LWFwaS90ZXN0cy9zZXR1cC50cyIsIm1hcHBpbmdzIjoiOzs7QUF1QkEsY0FBYztBQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUUvQixhQUFhO0FBQ2IsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUVyQix1Q0FBdUM7QUFDdkMsSUFBSSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3BDLE1BQU0sRUFBRTtRQUNOLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2YsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDaEIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtLQUNqQjtDQUNGLENBQUMsQ0FBQyxDQUFDO0FBRUosY0FBYztBQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDekIsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLElBQUksRUFBRTtZQUNKLFdBQVcsRUFBRTtnQkFDWCxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDO29CQUNsQyxPQUFPLEVBQUU7d0JBQ1A7NEJBQ0UsT0FBTyxFQUFFO2dDQUNQLE9BQU8sRUFBRSxrQkFBa0I7Z0NBQzNCLElBQUksRUFBRSxXQUFXOzZCQUNsQjt5QkFDRjtxQkFDRjtpQkFDRixDQUFDO2FBQ0g7U0FDRjtRQUNELFVBQVUsRUFBRTtZQUNWLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUM7Z0JBQ2xDLElBQUksRUFBRTtvQkFDSjt3QkFDRSxT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RUFBRSxFQUFFLGNBQWM7SUFDbEIsS0FBSyxFQUFFLGtCQUFrQjtJQUN6QixjQUFjLEVBQUUsYUFBYTtJQUM3QixLQUFLLEVBQUUsQ0FBQyxPQUFPLENBQUM7Q0FDakIsQ0FBQztBQUVGLG1DQUFtQztBQUNuQyxNQUFNLFFBQVEsR0FBRyxJQUFJLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2xELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUNyQixJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRTdCLDRCQUE0QjtBQUMzQixNQUFjLENBQUMsYUFBYSxHQUFHLEdBQUcsRUFBRTtJQUNuQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDckIsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0FBQ3hCLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMveXVzdWtleW9zaGlva2EvcHJvamVjdHMveW91dHViZS9haS1jaGF0L2FpLWNoYXQtYXBpL3Rlc3RzL3NldHVwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIFNldCB1cCB0ZXN0IGVudmlyb25tZW50XG5pbXBvcnQgJ3JlZmxlY3QtbWV0YWRhdGEnO1xuaW1wb3J0IHsgVGV4dEVuY29kZXIsIFRleHREZWNvZGVyIH0gZnJvbSAndXRpbCc7XG5cbi8vIFNldCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgZm9yIHRlc3RzXG5wcm9jZXNzLmVudi5OT0RFX0VOViA9ICd0ZXN0JztcbnByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCA9ICdwb3N0Z3Jlc3FsOi8vdGVzdDp0ZXN0QGxvY2FsaG9zdDo1NDMyL3Rlc3QnO1xucHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9ICd0ZXN0LXNlY3JldC1rZXknO1xucHJvY2Vzcy5lbnYuU1RSSVBFX1NFQ1JFVF9LRVkgPSAnc2tfdGVzdF9tb2NrJztcbnByb2Nlc3MuZW52LlNFTkRHUklEX0FQSV9LRVkgPSAnU0cudGVzdC1rZXknO1xucHJvY2Vzcy5lbnYuUURSQU5UX1VSTCA9ICdodHRwOi8vbG9jYWxob3N0OjYzMzMnO1xucHJvY2Vzcy5lbnYuUURSQU5UX0FQSV9LRVkgPSAndGVzdC1xZHJhbnQta2V5JztcbnByb2Nlc3MuZW52LkFXU19BQ0NFU1NfS0VZX0lEID0gJ3Rlc3QtYXdzLWtleSc7XG5wcm9jZXNzLmVudi5BV1NfU0VDUkVUX0FDQ0VTU19LRVkgPSAndGVzdC1hd3Mtc2VjcmV0JztcbnByb2Nlc3MuZW52LkFXU19SRUdJT04gPSAndXMtZWFzdC0xJztcbnByb2Nlc3MuZW52LlMzX0JVQ0tFVF9OQU1FID0gJ3Rlc3QtYnVja2V0JztcbnByb2Nlc3MuZW52LlJFRElTX1VSTCA9ICdyZWRpczovL2xvY2FsaG9zdDo2Mzc5JztcbnByb2Nlc3MuZW52Lk9QRU5BSV9BUElfS0VZID0gJ3NrLXRlc3QtbW9jayc7XG5cbi8vIE1vY2sgZ2xvYmFsIG9iamVjdHNcbmdsb2JhbC5UZXh0RW5jb2RlciA9IFRleHRFbmNvZGVyO1xuZ2xvYmFsLlRleHREZWNvZGVyID0gVGV4dERlY29kZXIgYXMgYW55O1xuXG4vLyBNb2NrIFByaXNtYVxuamVzdC5tb2NrKCcuLi9zcmMvbGliL3ByaXNtYScpO1xuXG4vLyBNb2NrIFJlZGlzXG5qZXN0Lm1vY2soJ2lvcmVkaXMnKTtcblxuLy8gTW9jayBsb2dnZXIgdG8gcmVkdWNlIG5vaXNlIGluIHRlc3RzXG5qZXN0Lm1vY2soJy4uL3NyYy9saWIvbG9nZ2VyJywgKCkgPT4gKHtcbiAgbG9nZ2VyOiB7XG4gICAgaW5mbzogamVzdC5mbigpLFxuICAgIGVycm9yOiBqZXN0LmZuKCksXG4gICAgd2FybjogamVzdC5mbigpLFxuICAgIGRlYnVnOiBqZXN0LmZuKCksXG4gIH0sXG59KSk7XG5cbi8vIE1vY2sgT3BlbkFJXG5qZXN0Lm1vY2soJ29wZW5haScsICgpID0+ICh7XG4gIGRlZmF1bHQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHtcbiAgICBjaGF0OiB7XG4gICAgICBjb21wbGV0aW9uczoge1xuICAgICAgICBjcmVhdGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgICAgY2hvaWNlczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBtZXNzYWdlOiB7XG4gICAgICAgICAgICAgICAgY29udGVudDogJ01vY2sgQUkgcmVzcG9uc2UnLFxuICAgICAgICAgICAgICAgIHJvbGU6ICdhc3Npc3RhbnQnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICBdLFxuICAgICAgICB9KSxcbiAgICAgIH0sXG4gICAgfSxcbiAgICBlbWJlZGRpbmdzOiB7XG4gICAgICBjcmVhdGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIGRhdGE6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBlbWJlZGRpbmc6IG5ldyBBcnJheSgxNTM2KS5maWxsKDAuMSksXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgIH0pLFxuICAgIH0sXG4gIH0pKSxcbn0pKTtcblxuLy8gTW9jayBTdHJpcGVcbmplc3QubW9jaygnc3RyaXBlJywgKCkgPT4gKHtcbiAgZGVmYXVsdDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiAoe1xuICAgIGN1c3RvbWVyczoge1xuICAgICAgY3JlYXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBpZDogJ2N1c190ZXN0JyB9KSxcbiAgICAgIHJldHJpZXZlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBpZDogJ2N1c190ZXN0JyB9KSxcbiAgICAgIHVwZGF0ZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6ICdjdXNfdGVzdCcgfSksXG4gICAgfSxcbiAgICBwcmljZXM6IHtcbiAgICAgIGxpc3Q6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIGRhdGE6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpZDogJ3ByaWNlX3Rlc3QnLFxuICAgICAgICAgICAgcHJvZHVjdDogJ3Byb2RfdGVzdCcsXG4gICAgICAgICAgICB1bml0X2Ftb3VudDogMTAwMCxcbiAgICAgICAgICAgIGN1cnJlbmN5OiAndXNkJyxcbiAgICAgICAgICAgIHJlY3VycmluZzogeyBpbnRlcnZhbDogJ21vbnRoJyB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9KSxcbiAgICB9LFxuICAgIHN1YnNjcmlwdGlvbnM6IHtcbiAgICAgIGNyZWF0ZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6ICdzdWJfdGVzdCcgfSksXG4gICAgICByZXRyaWV2ZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6ICdzdWJfdGVzdCcgfSksXG4gICAgICB1cGRhdGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGlkOiAnc3ViX3Rlc3QnIH0pLFxuICAgICAgY2FuY2VsOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBpZDogJ3N1Yl90ZXN0JyB9KSxcbiAgICB9LFxuICAgIGNoZWNrb3V0OiB7XG4gICAgICBzZXNzaW9uczoge1xuICAgICAgICBjcmVhdGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgICAgaWQ6ICdjc190ZXN0JyxcbiAgICAgICAgICB1cmw6ICdodHRwczovL2NoZWNrb3V0LnN0cmlwZS5jb20vdGVzdCcsXG4gICAgICAgIH0pLFxuICAgICAgfSxcbiAgICB9LFxuICAgIGJpbGxpbmdQb3J0YWw6IHtcbiAgICAgIHNlc3Npb25zOiB7XG4gICAgICAgIGNyZWF0ZTogamVzdFxuICAgICAgICAgIC5mbigpXG4gICAgICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlKHsgdXJsOiAnaHR0cHM6Ly9iaWxsaW5nLnN0cmlwZS5jb20vdGVzdCcgfSksXG4gICAgICB9LFxuICAgIH0sXG4gICAgd2ViaG9va0VuZHBvaW50czoge1xuICAgICAgY3JlYXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBpZDogJ3dlX3Rlc3QnIH0pLFxuICAgIH0sXG4gIH0pKSxcbn0pKTtcblxuLy8gTW9jayBTZW5kR3JpZFxuamVzdC5tb2NrKCdAc2VuZGdyaWQvbWFpbCcsICgpID0+ICh7XG4gIHNldEFwaUtleTogamVzdC5mbigpLFxuICBzZW5kOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoW3t9XSksXG59KSk7XG5cbi8vIE1vY2sgUWRyYW50XG5qZXN0Lm1vY2soJ0BxZHJhbnQvanMtY2xpZW50LXJlc3QnLCAoKSA9PiAoe1xuICBRZHJhbnRDbGllbnQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHtcbiAgICBjcmVhdGVDb2xsZWN0aW9uOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodHJ1ZSksXG4gICAgZ2V0Q29sbGVjdGlvbjogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgc3RhdHVzOiAnZ3JlZW4nIH0pLFxuICAgIHVwc2VydDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgb3BlcmF0aW9uX2lkOiAxIH0pLFxuICAgIHNlYXJjaDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgIHJlc3VsdDogW1xuICAgICAgICB7XG4gICAgICAgICAgaWQ6ICd2ZWMtMScsXG4gICAgICAgICAgc2NvcmU6IDAuOTUsXG4gICAgICAgICAgcGF5bG9hZDoge1xuICAgICAgICAgICAgY29udGVudDogJ1Rlc3QgY29udGVudCcsXG4gICAgICAgICAgICBtZXRhZGF0YToge30sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSksXG4gICAgZGVsZXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBvcGVyYXRpb25faWQ6IDEgfSksXG4gIH0pKSxcbn0pKTtcblxuLy8gTW9jayBBV1MgU0RLXG5qZXN0Lm1vY2soJ0Bhd3Mtc2RrL2NsaWVudC1zMycsICgpID0+ICh7XG4gIFMzQ2xpZW50OiBqZXN0LmZuKCksXG4gIFB1dE9iamVjdENvbW1hbmQ6IGplc3QuZm4oKSxcbiAgR2V0T2JqZWN0Q29tbWFuZDogamVzdC5mbigpLFxuICBEZWxldGVPYmplY3RDb21tYW5kOiBqZXN0LmZuKCksXG59KSk7XG5cbi8vIE1vY2sgU29ja2V0LklPXG5qZXN0Lm1vY2soJ3NvY2tldC5pbycsICgpID0+IHtcbiAgY29uc3QgbW9ja1NvY2tldCA9IHtcbiAgICBpZDogJ3Rlc3Qtc29ja2V0LWlkJyxcbiAgICBlbWl0OiBqZXN0LmZuKCksXG4gICAgb246IGplc3QuZm4oKSxcbiAgICBqb2luOiBqZXN0LmZuKCksXG4gICAgbGVhdmU6IGplc3QuZm4oKSxcbiAgICBkaXNjb25uZWN0OiBqZXN0LmZuKCksXG4gIH07XG5cbiAgY29uc3QgbW9ja0lvOiBhbnkgPSB7XG4gICAgb246IGplc3QuZm4oKGV2ZW50OiBzdHJpbmcsIGhhbmRsZXI6IChzb2NrZXQ6IGFueSkgPT4gdm9pZCkgPT4ge1xuICAgICAgaWYgKGV2ZW50ID09PSAnY29ubmVjdGlvbicpIHtcbiAgICAgICAgLy8gU2ltdWxhdGUgYSBjb25uZWN0aW9uXG4gICAgICAgIHNldEltbWVkaWF0ZSgoKSA9PiBoYW5kbGVyKG1vY2tTb2NrZXQpKTtcbiAgICAgIH1cbiAgICB9KSxcbiAgICBlbWl0OiBqZXN0LmZuKCksXG4gICAgdG86IGplc3QuZm4oKCkgPT4gbW9ja0lvKSxcbiAgICBpbjogamVzdC5mbigoKSA9PiBtb2NrSW8pLFxuICAgIHNvY2tldHM6IHtcbiAgICAgIHNvY2tldHM6IG5ldyBNYXAoW1ttb2NrU29ja2V0LmlkLCBtb2NrU29ja2V0XV0pLFxuICAgIH0sXG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICBTZXJ2ZXI6IGplc3QuZm4oKCkgPT4gbW9ja0lvKSxcbiAgfTtcbn0pO1xuXG4vLyBDbGVhbiB1cCBhZnRlciBlYWNoIHRlc3RcbmFmdGVyRWFjaCgoKSA9PiB7XG4gIGplc3QuY2xlYXJBbGxNb2NrcygpO1xufSk7XG5cbi8vIEdsb2JhbCB0ZXN0IHRpbWVvdXRcbmplc3Quc2V0VGltZW91dCgzMDAwMCk7XG5cbi8vIFRlc3QgaGVscGVyc1xuZXhwb3J0IGNvbnN0IG1vY2tBdXRoVXNlciA9IHtcbiAgaWQ6ICd0ZXN0LXVzZXItaWQnLFxuICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICBvcmdhbml6YXRpb25JZDogJ3Rlc3Qtb3JnLWlkJyxcbiAgcm9sZXM6IFsnYWRtaW4nXSxcbn07XG5cbi8vIE1vY2sgZGF0ZSBmb3IgY29uc2lzdGVudCB0ZXN0aW5nXG5jb25zdCBtb2NrRGF0ZSA9IG5ldyBEYXRlKCcyMDI0LTAxLTAxVDAwOjAwOjAwWicpO1xuamVzdC51c2VGYWtlVGltZXJzKCk7XG5qZXN0LnNldFN5c3RlbVRpbWUobW9ja0RhdGUpO1xuXG4vLyBIZWxwZXIgdG8gcmVzZXQgYWxsIG1vY2tzXG4oZ2xvYmFsIGFzIGFueSkucmVzZXRBbGxNb2NrcyA9ICgpID0+IHtcbiAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gIGplc3QuY2xlYXJBbGxUaW1lcnMoKTtcbn07XG4iXSwidmVyc2lvbiI6M30=