c554605043c0407695c87c8328c4758d
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const supertest_1 = __importDefault(require("supertest"));
const app_1 = __importDefault(require("../../src/app"));
const prisma_1 = require("../../src/lib/prisma");
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const client_1 = require("@prisma/client");
describe('Reports Routes', () => {
    let authToken;
    let userId;
    let organizationId;
    let widgetId;
    beforeEach(() => __awaiter(void 0, void 0, void 0, function* () {
        // Create test organization
        const organization = yield prisma_1.prisma.organization.create({
            data: {
                name: 'Test Organization',
                slug: 'test-org',
            },
        });
        organizationId = organization.id;
        // Create test company
        const company = yield prisma_1.prisma.company.create({
            data: {
                name: 'Test Company',
                email: 'company@example.com',
                organizationId,
            },
        });
        // Create test widget
        const widget = yield prisma_1.prisma.widget.create({
            data: {
                widgetKey: 'test-widget',
                name: 'Test Widget',
                companyId: company.id,
            },
        });
        widgetId = widget.id;
        // Create test user
        const user = yield prisma_1.prisma.user.create({
            data: {
                email: 'test@example.com',
                password: 'hashed_password',
                name: 'Test User',
                roles: [client_1.Role.org_admin],
                organizationId,
            },
        });
        userId = user.id;
        authToken = jsonwebtoken_1.default.sign({ userId: user.id, email: user.email }, process.env.JWT_SECRET, { expiresIn: '1d' });
        // Create test chat logs
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        yield prisma_1.prisma.chatLog.createMany({
            data: [
                {
                    userId,
                    widgetId,
                    question: 'How do I reset my password?',
                    answer: 'You can reset your password from the settings page.',
                    tokens: 15,
                    createdAt: new Date(),
                },
                {
                    userId,
                    widgetId,
                    question: 'What are your business hours?',
                    answer: 'We are open Monday to Friday, 9 AM to 5 PM.',
                    tokens: 12,
                    createdAt: yesterday,
                },
                {
                    userId,
                    widgetId,
                    question: 'How can I contact support?',
                    answer: 'You can contact support at support@example.com.',
                    tokens: 10,
                    createdAt: weekAgo,
                },
            ],
        });
    }));
    describe('GET /api/reports/summary', () => {
        it('should return report summary for default period', () => __awaiter(void 0, void 0, void 0, function* () {
            const response = yield (0, supertest_1.default)(app_1.default)
                .get('/api/reports/summary')
                .set('Cookie', `auth-token=${authToken}`);
            expect(response.status).toBe(200);
            expect(response.body).toHaveProperty('totalChats');
            expect(response.body).toHaveProperty('uniqueUsers');
            expect(response.body).toHaveProperty('totalTokens');
            expect(response.body).toHaveProperty('avgTokensPerChat');
            expect(response.body).toHaveProperty('topQuestions');
            expect(response.body.topQuestions).toBeInstanceOf(Array);
        }));
        it('should filter by date range', () => __awaiter(void 0, void 0, void 0, function* () {
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 2);
            const endDate = new Date();
            const response = yield (0, supertest_1.default)(app_1.default)
                .get('/api/reports/summary')
                .set('Cookie', `auth-token=${authToken}`)
                .query({
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString(),
            });
            expect(response.status).toBe(200);
            expect(response.body.totalChats).toBe(2); // Only today and yesterday
        }));
        it('should filter by widget', () => __awaiter(void 0, void 0, void 0, function* () {
            // Create another widget with no chats
            const anotherWidget = yield prisma_1.prisma.widget.create({
                data: {
                    widgetKey: 'another-widget',
                    name: 'Another Widget',
                    companyId: (yield prisma_1.prisma.company.findFirst()).id,
                },
            });
            const response = yield (0, supertest_1.default)(app_1.default)
                .get('/api/reports/summary')
                .set('Cookie', `auth-token=${authToken}`)
                .query({ widgetId });
            expect(response.status).toBe(200);
            expect(response.body.totalChats).toBe(3);
        }));
    });
    describe('GET /api/reports/chart', () => {
        it('should return chart data grouped by day', () => __awaiter(void 0, void 0, void 0, function* () {
            const response = yield (0, supertest_1.default)(app_1.default)
                .get('/api/reports/chart')
                .set('Cookie', `auth-token=${authToken}`)
                .query({ groupBy: 'day' });
            expect(response.status).toBe(200);
            expect(response.body).toHaveProperty('data');
            expect(response.body.data).toBeInstanceOf(Array);
            expect(response.body.data.length).toBeGreaterThan(0);
            response.body.data.forEach((item) => {
                expect(item).toHaveProperty('date');
                expect(item).toHaveProperty('count');
                expect(item).toHaveProperty('tokens');
            });
        }));
        it('should support grouping by hour', () => __awaiter(void 0, void 0, void 0, function* () {
            const response = yield (0, supertest_1.default)(app_1.default)
                .get('/api/reports/chart')
                .set('Cookie', `auth-token=${authToken}`)
                .query({ groupBy: 'hour' });
            expect(response.status).toBe(200);
            expect(response.body.data).toBeInstanceOf(Array);
        }));
        it('should support grouping by week', () => __awaiter(void 0, void 0, void 0, function* () {
            const response = yield (0, supertest_1.default)(app_1.default)
                .get('/api/reports/chart')
                .set('Cookie', `auth-token=${authToken}`)
                .query({ groupBy: 'week' });
            expect(response.status).toBe(200);
            expect(response.body.data).toBeInstanceOf(Array);
        }));
        it('should support grouping by month', () => __awaiter(void 0, void 0, void 0, function* () {
            const response = yield (0, supertest_1.default)(app_1.default)
                .get('/api/reports/chart')
                .set('Cookie', `auth-token=${authToken}`)
                .query({ groupBy: 'month' });
            expect(response.status).toBe(200);
            expect(response.body.data).toBeInstanceOf(Array);
        }));
    });
    describe('GET /api/reports/csv', () => {
        it('should export report data as CSV', () => __awaiter(void 0, void 0, void 0, function* () {
            const response = yield (0, supertest_1.default)(app_1.default)
                .get('/api/reports/csv')
                .set('Cookie', `auth-token=${authToken}`);
            expect(response.status).toBe(200);
            expect(response.headers['content-type']).toContain('text/csv');
            expect(response.headers['content-disposition']).toContain('attachment');
            expect(response.headers['content-disposition']).toContain('chat-report');
            // Check CSV content
            const csvLines = response.text.split('\n');
            expect(csvLines.length).toBeGreaterThan(1); // Header + data
            expect(csvLines[0]).toContain('Date');
            expect(csvLines[0]).toContain('User');
            expect(csvLines[0]).toContain('Question');
        }));
        it('should include date range in filename', () => __awaiter(void 0, void 0, void 0, function* () {
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            const response = yield (0, supertest_1.default)(app_1.default)
                .get('/api/reports/csv')
                .set('Cookie', `auth-token=${authToken}`)
                .query({ startDate: startDate.toISOString() });
            expect(response.status).toBe(200);
            expect(response.headers['content-disposition']).toContain('chat-report');
        }));
        it('should handle empty results', () => __awaiter(void 0, void 0, void 0, function* () {
            // Query for future dates to get empty results
            const futureDate = new Date();
            futureDate.setFullYear(futureDate.getFullYear() + 1);
            const response = yield (0, supertest_1.default)(app_1.default)
                .get('/api/reports/csv')
                .set('Cookie', `auth-token=${authToken}`)
                .query({
                startDate: futureDate.toISOString(),
                endDate: futureDate.toISOString(),
            });
            expect(response.status).toBe(200);
            expect(response.headers['content-type']).toContain('text/csv');
            const csvLines = response.text.split('\n').filter((line) => line.trim());
            expect(csvLines.length).toBe(1); // Only header
        }));
    });
    describe('Error handling', () => {
        it('should return 401 for unauthenticated requests', () => __awaiter(void 0, void 0, void 0, function* () {
            const endpoints = ['/summary', '/chart', '/csv'];
            for (const endpoint of endpoints) {
                const response = yield (0, supertest_1.default)(app_1.default).get(`/api/reports${endpoint}`);
                expect(response.status).toBe(401);
            }
        }));
        it('should handle database errors gracefully', () => __awaiter(void 0, void 0, void 0, function* () {
            jest
                .spyOn(prisma_1.prisma.chatLog, 'count')
                .mockRejectedValueOnce(new Error('DB Error'));
            const response = yield (0, supertest_1.default)(app_1.default)
                .get('/api/reports/summary')
                .set('Cookie', `auth-token=${authToken}`);
            expect(response.status).toBe(500);
            expect(response.body).toHaveProperty('error');
        }));
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3l1c3VrZXlvc2hpb2thL3Byb2plY3RzL3lvdXR1YmUvYWktY2hhdC9haS1jaGF0LWFwaS90ZXN0cy9pbnRlZ3JhdGlvbi9yZXBvcnRzLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQSwwREFBZ0M7QUFDaEMsd0RBQWdDO0FBQ2hDLGlEQUE4QztBQUM5QyxnRUFBK0I7QUFDL0IsMkNBQXNDO0FBRXRDLFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7SUFDOUIsSUFBSSxTQUFpQixDQUFDO0lBQ3RCLElBQUksTUFBYyxDQUFDO0lBQ25CLElBQUksY0FBc0IsQ0FBQztJQUMzQixJQUFJLFFBQWdCLENBQUM7SUFFckIsVUFBVSxDQUFDLEdBQVMsRUFBRTtRQUNwQiwyQkFBMkI7UUFDM0IsTUFBTSxZQUFZLEdBQUcsTUFBTSxlQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQztZQUNwRCxJQUFJLEVBQUU7Z0JBQ0osSUFBSSxFQUFFLG1CQUFtQjtnQkFDekIsSUFBSSxFQUFFLFVBQVU7YUFDakI7U0FDRixDQUFDLENBQUM7UUFDSCxjQUFjLEdBQUcsWUFBWSxDQUFDLEVBQUUsQ0FBQztRQUVqQyxzQkFBc0I7UUFDdEIsTUFBTSxPQUFPLEdBQUcsTUFBTSxlQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztZQUMxQyxJQUFJLEVBQUU7Z0JBQ0osSUFBSSxFQUFFLGNBQWM7Z0JBQ3BCLEtBQUssRUFBRSxxQkFBcUI7Z0JBQzVCLGNBQWM7YUFDZjtTQUNGLENBQUMsQ0FBQztRQUVILHFCQUFxQjtRQUNyQixNQUFNLE1BQU0sR0FBRyxNQUFNLGVBQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDO1lBQ3hDLElBQUksRUFBRTtnQkFDSixTQUFTLEVBQUUsYUFBYTtnQkFDeEIsSUFBSSxFQUFFLGFBQWE7Z0JBQ25CLFNBQVMsRUFBRSxPQUFPLENBQUMsRUFBRTthQUN0QjtTQUNGLENBQUMsQ0FBQztRQUNILFFBQVEsR0FBRyxNQUFNLENBQUMsRUFB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UUFDaEQsQ0FBQyxDQUFBLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL3l1c3VrZXlvc2hpb2thL3Byb2plY3RzL3lvdXR1YmUvYWktY2hhdC9haS1jaGF0LWFwaS90ZXN0cy9pbnRlZ3JhdGlvbi9yZXBvcnRzLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlcXVlc3QgZnJvbSAnc3VwZXJ0ZXN0JztcbmltcG9ydCBhcHAgZnJvbSAnLi4vLi4vc3JjL2FwcCc7XG5pbXBvcnQgeyBwcmlzbWEgfSBmcm9tICcuLi8uLi9zcmMvbGliL3ByaXNtYSc7XG5pbXBvcnQgand0IGZyb20gJ2pzb253ZWJ0b2tlbic7XG5pbXBvcnQgeyBSb2xlIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuXG5kZXNjcmliZSgnUmVwb3J0cyBSb3V0ZXMnLCAoKSA9PiB7XG4gIGxldCBhdXRoVG9rZW46IHN0cmluZztcbiAgbGV0IHVzZXJJZDogc3RyaW5nO1xuICBsZXQgb3JnYW5pemF0aW9uSWQ6IHN0cmluZztcbiAgbGV0IHdpZGdldElkOiBzdHJpbmc7XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgLy8gQ3JlYXRlIHRlc3Qgb3JnYW5pemF0aW9uXG4gICAgY29uc3Qgb3JnYW5pemF0aW9uID0gYXdhaXQgcHJpc21hLm9yZ2FuaXphdGlvbi5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICBuYW1lOiAnVGVzdCBPcmdhbml6YXRpb24nLFxuICAgICAgICBzbHVnOiAndGVzdC1vcmcnLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBvcmdhbml6YXRpb25JZCA9IG9yZ2FuaXphdGlvbi5pZDtcblxuICAgIC8vIENyZWF0ZSB0ZXN0IGNvbXBhbnlcbiAgICBjb25zdCBjb21wYW55ID0gYXdhaXQgcHJpc21hLmNvbXBhbnkuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgbmFtZTogJ1Rlc3QgQ29tcGFueScsXG4gICAgICAgIGVtYWlsOiAnY29tcGFueUBleGFtcGxlLmNvbScsXG4gICAgICAgIG9yZ2FuaXphdGlvbklkLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSB0ZXN0IHdpZGdldFxuICAgIGNvbnN0IHdpZGdldCA9IGF3YWl0IHByaXNtYS53aWRnZXQuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgd2lkZ2V0S2V5OiAndGVzdC13aWRnZXQnLFxuICAgICAgICBuYW1lOiAnVGVzdCBXaWRnZXQnLFxuICAgICAgICBjb21wYW55SWQ6IGNvbXBhbnkuaWQsXG4gICAgICB9LFxuICAgIH0pO1xuICAgIHdpZGdldElkID0gd2lkZ2V0LmlkO1xuXG4gICAgLy8gQ3JlYXRlIHRlc3QgdXNlclxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBwcmlzbWEudXNlci5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgICAgICBwYXNzd29yZDogJ2hhc2hlZF9wYXNzd29yZCcsXG4gICAgICAgIG5hbWU6ICdUZXN0IFVzZXInLFxuICAgICAgICByb2xlczogW1JvbGUub3JnX2FkbWluXSxcbiAgICAgICAgb3JnYW5pemF0aW9uSWQsXG4gICAgICB9LFxuICAgIH0pO1xuICAgIHVzZXJJZCA9IHVzZXIuaWQ7XG5cbiAgICBhdXRoVG9rZW4gPSBqd3Quc2lnbihcbiAgICAgIHsgdXNlcklkOiB1c2VyLmlkLCBlbWFpbDogdXNlci5lbWFpbCB9LFxuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCEsXG4gICAgICB7IGV4cGlyZXNJbjogJzFkJyB9XG4gICAgKTtcblxuICAgIC8vIENyZWF0ZSB0ZXN0IGNoYXQgbG9nc1xuICAgIGNvbnN0IHllc3RlcmRheSA9IG5ldyBEYXRlKCk7XG4gICAgeWVzdGVyZGF5LnNldERhdGUoeWVzdGVyZGF5LmdldERhdGUoKSAtIDEpO1xuXG4gICAgY29uc3Qgd2Vla0FnbyA9IG5ldyBEYXRlKCk7XG4gICAgd2Vla0Fnby5zZXREYXRlKHdlZWtBZ28uZ2V0RGF0ZSgpIC0gNyk7XG5cbiAgICBhd2FpdCBwcmlzbWEuY2hhdExvZy5jcmVhdGVNYW55KHtcbiAgICAgIGRhdGE6IFtcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICB3aWRnZXRJZCxcbiAgICAgICAgICBxdWVzdGlvbjogJ0hvdyBkbyBJIHJlc2V0IG15IHBhc3N3b3JkPycsXG4gICAgICAgICAgYW5zd2VyOiAnWW91IGNhbiByZXNldCB5b3VyIHBhc3N3b3JkIGZyb20gdGhlIHNldHRpbmdzIHBhZ2UuJyxcbiAgICAgICAgICB0b2tlbnM6IDE1LFxuICAgICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICB3aWRnZXRJZCxcbiAgICAgICAgICBxdWVzdGlvbjogJ1doYXQgYXJlIHlvdXIgYnVzaW5lc3MgaG91cnM/JyxcbiAgICAgICAgICBhbnN3ZXI6ICdXZSBhcmUgb3BlbiBNb25kYXkgdG8gRnJpZGF5LCA5IEFNIHRvIDUgUE0uJyxcbiAgICAgICAgICB0b2tlbnM6IDEyLFxuICAgICAgICAgIGNyZWF0ZWRBdDogeWVzdGVyZGF5LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIHdpZGdldElkLFxuICAgICAgICAgIHF1ZXN0aW9uOiAnSG93IGNhbiBJIGNvbnRhY3Qgc3VwcG9ydD8nLFxuICAgICAgICAgIGFuc3dlcjogJ1lvdSBjYW4gY29udGFjdCBzdXBwb3J0IGF0IHN1cHBvcnRAZXhhbXBsZS5jb20uJyxcbiAgICAgICAgICB0b2tlbnM6IDEwLFxuICAgICAgICAgIGNyZWF0ZWRBdDogd2Vla0FnbyxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdHRVQgL2FwaS9yZXBvcnRzL3N1bW1hcnknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gcmVwb3J0IHN1bW1hcnkgZm9yIGRlZmF1bHQgcGVyaW9kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9yZXBvcnRzL3N1bW1hcnknKVxuICAgICAgICAuc2V0KCdDb29raWUnLCBgYXV0aC10b2tlbj0ke2F1dGhUb2tlbn1gKTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvSGF2ZVByb3BlcnR5KCd0b3RhbENoYXRzJyk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9IYXZlUHJvcGVydHkoJ3VuaXF1ZVVzZXJzJyk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9IYXZlUHJvcGVydHkoJ3RvdGFsVG9rZW5zJyk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9IYXZlUHJvcGVydHkoJ2F2Z1Rva2Vuc1BlckNoYXQnKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5KS50b0hhdmVQcm9wZXJ0eSgndG9wUXVlc3Rpb25zJyk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS50b3BRdWVzdGlvbnMpLnRvQmVJbnN0YW5jZU9mKEFycmF5KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZmlsdGVyIGJ5IGRhdGUgcmFuZ2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZSgpO1xuICAgICAgc3RhcnREYXRlLnNldERhdGUoc3RhcnREYXRlLmdldERhdGUoKSAtIDIpO1xuICAgICAgY29uc3QgZW5kRGF0ZSA9IG5ldyBEYXRlKCk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvcmVwb3J0cy9zdW1tYXJ5JylcbiAgICAgICAgLnNldCgnQ29va2llJywgYGF1dGgtdG9rZW49JHthdXRoVG9rZW59YClcbiAgICAgICAgLnF1ZXJ5KHtcbiAgICAgICAgICBzdGFydERhdGU6IHN0YXJ0RGF0ZS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIGVuZERhdGU6IGVuZERhdGUudG9JU09TdHJpbmcoKSxcbiAgICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LnRvdGFsQ2hhdHMpLnRvQmUoMik7IC8vIE9ubHkgdG9kYXkgYW5kIHllc3RlcmRheVxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBmaWx0ZXIgYnkgd2lkZ2V0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ3JlYXRlIGFub3RoZXIgd2lkZ2V0IHdpdGggbm8gY2hhdHNcbiAgICAgIGNvbnN0IGFub3RoZXJXaWRnZXQgPSBhd2FpdCBwcmlzbWEud2lkZ2V0LmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB3aWRnZXRLZXk6ICdhbm90aGVyLXdpZGdldCcsXG4gICAgICAgICAgbmFtZTogJ0Fub3RoZXIgV2lkZ2V0JyxcbiAgICAgICAgICBjb21wYW55SWQ6IChhd2FpdCBwcmlzbWEuY29tcGFueS5maW5kRmlyc3QoKSkhLmlkLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvcmVwb3J0cy9zdW1tYXJ5JylcbiAgICAgICAgLnNldCgnQ29va2llJywgYGF1dGgtdG9rZW49JHthdXRoVG9rZW59YClcbiAgICAgICAgLnF1ZXJ5KHsgd2lkZ2V0SWQgfSk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LnRvdGFsQ2hhdHMpLnRvQmUoMyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdHRVQgL2FwaS9yZXBvcnRzL2NoYXJ0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGNoYXJ0IGRhdGEgZ3JvdXBlZCBieSBkYXknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAuZ2V0KCcvYXBpL3JlcG9ydHMvY2hhcnQnKVxuICAgICAgICAuc2V0KCdDb29raWUnLCBgYXV0aC10b2tlbj0ke2F1dGhUb2tlbn1gKVxuICAgICAgICAucXVlcnkoeyBncm91cEJ5OiAnZGF5JyB9KTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvSGF2ZVByb3BlcnR5KCdkYXRhJyk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5kYXRhKS50b0JlSW5zdGFuY2VPZihBcnJheSk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5kYXRhLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xuXG4gICAgICByZXNwb25zZS5ib2R5LmRhdGEuZm9yRWFjaCgoaXRlbTogYW55KSA9PiB7XG4gICAgICAgIGV4cGVjdChpdGVtKS50b0hhdmVQcm9wZXJ0eSgnZGF0ZScpO1xuICAgICAgICBleHBlY3QoaXRlbSkudG9IYXZlUHJvcGVydHkoJ2NvdW50Jyk7XG4gICAgICAgIGV4cGVjdChpdGVtKS50b0hhdmVQcm9wZXJ0eSgndG9rZW5zJyk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc3VwcG9ydCBncm91cGluZyBieSBob3VyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9yZXBvcnRzL2NoYXJ0JylcbiAgICAgICAgLnNldCgnQ29va2llJywgYGF1dGgtdG9rZW49JHthdXRoVG9rZW59YClcbiAgICAgICAgLnF1ZXJ5KHsgZ3JvdXBCeTogJ2hvdXInIH0pO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5kYXRhKS50b0JlSW5zdGFuY2VPZihBcnJheSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHN1cHBvcnQgZ3JvdXBpbmcgYnkgd2VlaycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvcmVwb3J0cy9jaGFydCcpXG4gICAgICAgIC5zZXQoJ0Nvb2tpZScsIGBhdXRoLXRva2VuPSR7YXV0aFRva2VufWApXG4gICAgICAgIC5xdWVyeSh7IGdyb3VwQnk6ICd3ZWVrJyB9KTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuZGF0YSkudG9CZUluc3RhbmNlT2YoQXJyYXkpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBzdXBwb3J0IGdyb3VwaW5nIGJ5IG1vbnRoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9yZXBvcnRzL2NoYXJ0JylcbiAgICAgICAgLnNldCgnQ29va2llJywgYGF1dGgtdG9rZW49JHthdXRoVG9rZW59YClcbiAgICAgICAgLnF1ZXJ5KHsgZ3JvdXBCeTogJ21vbnRoJyB9KTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuZGF0YSkudG9CZUluc3RhbmNlT2YoQXJyYXkpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnR0VUIC9hcGkvcmVwb3J0cy9jc3YnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBleHBvcnQgcmVwb3J0IGRhdGEgYXMgQ1NWJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9yZXBvcnRzL2NzdicpXG4gICAgICAgIC5zZXQoJ0Nvb2tpZScsIGBhdXRoLXRva2VuPSR7YXV0aFRva2VufWApO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuaGVhZGVyc1snY29udGVudC10eXBlJ10pLnRvQ29udGFpbigndGV4dC9jc3YnKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5oZWFkZXJzWydjb250ZW50LWRpc3Bvc2l0aW9uJ10pLnRvQ29udGFpbignYXR0YWNobWVudCcpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtZGlzcG9zaXRpb24nXSkudG9Db250YWluKCdjaGF0LXJlcG9ydCcpO1xuXG4gICAgICAvLyBDaGVjayBDU1YgY29udGVudFxuICAgICAgY29uc3QgY3N2TGluZXMgPSByZXNwb25zZS50ZXh0LnNwbGl0KCdcXG4nKTtcbiAgICAgIGV4cGVjdChjc3ZMaW5lcy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigxKTsgLy8gSGVhZGVyICsgZGF0YVxuICAgICAgZXhwZWN0KGNzdkxpbmVzWzBdKS50b0NvbnRhaW4oJ0RhdGUnKTtcbiAgICAgIGV4cGVjdChjc3ZMaW5lc1swXSkudG9Db250YWluKCdVc2VyJyk7XG4gICAgICBleHBlY3QoY3N2TGluZXNbMF0pLnRvQ29udGFpbignUXVlc3Rpb24nKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaW5jbHVkZSBkYXRlIHJhbmdlIGluIGZpbGVuYW1lJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUoKTtcbiAgICAgIHN0YXJ0RGF0ZS5zZXREYXRlKHN0YXJ0RGF0ZS5nZXREYXRlKCkgLSA3KTtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9yZXBvcnRzL2NzdicpXG4gICAgICAgIC5zZXQoJ0Nvb2tpZScsIGBhdXRoLXRva2VuPSR7YXV0aFRva2VufWApXG4gICAgICAgIC5xdWVyeSh7IHN0YXJ0RGF0ZTogc3RhcnREYXRlLnRvSVNPU3RyaW5nKCkgfSk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5oZWFkZXJzWydjb250ZW50LWRpc3Bvc2l0aW9uJ10pLnRvQ29udGFpbignY2hhdC1yZXBvcnQnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGVtcHR5IHJlc3VsdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBRdWVyeSBmb3IgZnV0dXJlIGRhdGVzIHRvIGdldCBlbXB0eSByZXN1bHRzXG4gICAgICBjb25zdCBmdXR1cmVEYXRlID0gbmV3IERhdGUoKTtcbiAgICAgIGZ1dHVyZURhdGUuc2V0RnVsbFllYXIoZnV0dXJlRGF0ZS5nZXRGdWxsWWVhcigpICsgMSk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvcmVwb3J0cy9jc3YnKVxuICAgICAgICAuc2V0KCdDb29raWUnLCBgYXV0aC10b2tlbj0ke2F1dGhUb2tlbn1gKVxuICAgICAgICAucXVlcnkoe1xuICAgICAgICAgIHN0YXJ0RGF0ZTogZnV0dXJlRGF0ZS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIGVuZERhdGU6IGZ1dHVyZURhdGUudG9JU09TdHJpbmcoKSxcbiAgICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5oZWFkZXJzWydjb250ZW50LXR5cGUnXSkudG9Db250YWluKCd0ZXh0L2NzdicpO1xuICAgICAgY29uc3QgY3N2TGluZXMgPSByZXNwb25zZS50ZXh0LnNwbGl0KCdcXG4nKS5maWx0ZXIoKGxpbmUpID0+IGxpbmUudHJpbSgpKTtcbiAgICAgIGV4cGVjdChjc3ZMaW5lcy5sZW5ndGgpLnRvQmUoMSk7IC8vIE9ubHkgaGVhZGVyXG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdFcnJvciBoYW5kbGluZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiA0MDEgZm9yIHVuYXV0aGVudGljYXRlZCByZXF1ZXN0cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGVuZHBvaW50cyA9IFsnL3N1bW1hcnknLCAnL2NoYXJ0JywgJy9jc3YnXTtcblxuICAgICAgZm9yIChjb25zdCBlbmRwb2ludCBvZiBlbmRwb2ludHMpIHtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcCkuZ2V0KGAvYXBpL3JlcG9ydHMke2VuZHBvaW50fWApO1xuXG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoNDAxKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGRhdGFiYXNlIGVycm9ycyBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgamVzdFxuICAgICAgICAuc3B5T24ocHJpc21hLmNoYXRMb2csICdjb3VudCcpXG4gICAgICAgIC5tb2NrUmVqZWN0ZWRWYWx1ZU9uY2UobmV3IEVycm9yKCdEQiBFcnJvcicpKTtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9yZXBvcnRzL3N1bW1hcnknKVxuICAgICAgICAuc2V0KCdDb29raWUnLCBgYXV0aC10b2tlbj0ke2F1dGhUb2tlbn1gKTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSg1MDApO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvSGF2ZVByb3BlcnR5KCdlcnJvcicpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9