{"version":3,"names":["cov_16a01t5oct","actualCoverage","express_1","s","require","router","Router","exports","widgetLoaderRoutes","get","req","res","f","__awaiter","matches","path","match","b","status","send","widgetKey","version","_a","loaderScript","generateLoaderScript","set","error","console","_version","apiUrl","process","env","NEXT_PUBLIC_API_URL","frontendUrl","FRONTEND_URL","trim"],"sources":["/Users/yusukeyoshioka/projects/youtube/ai-chat/ai-chat-api/src/routes/widgetLoader.ts"],"sourcesContent":["import { Router, Request, Response } from 'express';\n\nconst router = Router();\n\n/**\n *  /widget-loader/<widgetKey>.js\n *  /widget-loader/<widgetKey>.v<version>.js\n *\n *  - 「/widget-loader」は app.ts 側でマウント済みなので **ここには書かない**。\n *  - 正規表現で .js / .v1.js の両方を安全に受け取る。\n */\nrouter.get(\n  //           ┌─ [0] = widgetKey           ┐┌─ [1] = version (任意) ┐\n  /^\\/([^/]+?)(?:\\.v(\\d+))?\\.js$/,\n  async (req: Request, res: Response) => {\n    try {\n      const matches = req.path.match(/^\\/([^/]+?)(?:\\.v(\\d+))?\\.js$/);\n      if (!matches) {\n        return res.status(400).send('// Invalid widget path format');\n      }\n\n      const widgetKey = matches[1]; // 例: \"test-widget-key-2\"\n      const version = matches[2] ?? '1'; // 例: \"1\" / undefined → '1'\n\n      // --- ここで DB に問い合わせてもいいが、まずは 200 を返して動作確認 ---\n      const loaderScript = generateLoaderScript(widgetKey, `v${version}`);\n\n      res.set({\n        'Content-Type': 'application/javascript',\n        'Cache-Control': 'public, max-age=31536000, immutable',\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Methods': 'GET',\n        'Cross-Origin-Resource-Policy': 'cross-origin',\n      });\n\n      res.send(loaderScript);\n    } catch (error) {\n      console.error('Widget loader error:', error);\n      res.status(500).send('// Error loading widget');\n    }\n  }\n);\n\n/* ------------------------------------------------------------------ */\n/* ↓ 以降は変更なし -------------------------------------------------- */\n/* ------------------------------------------------------------------ */\n\nfunction generateLoaderScript(widgetKey: string, _version: string): string {\n  const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';\n  const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:3000';\n\n  return `\n(function () {\n  'use strict';\n  if (window.aiChatWidgetLoaded) return;\n  window.aiChatWidgetLoaded = true;\n\n  const WIDGET_KEY = '${widgetKey}';\n  const API_URL    = '${apiUrl}';\n  const WIDGET_URL = '${frontendUrl}/chat-widget';\n\n  function createWidget() {\n    fetch(API_URL + '/api/widgets/' + WIDGET_KEY)\n      .then(r => r.json())\n      .then(cfg => {\n        if (!cfg.isActive) return console.warn('AI Chat Widget is inactive');\n\n        const box = document.createElement('div');\n        box.id = 'ai-chat-widget-container';\n        box.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:9999;width:350px;height:500px;';\n\n        const iframe = document.createElement('iframe');\n        iframe.src = WIDGET_URL + '?widgetKey=' + WIDGET_KEY;\n        iframe.style.cssText = 'width:100%;height:100%;border:none;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.15);';\n        iframe.title = 'AI Chat Widget';\n\n        box.appendChild(iframe);\n        document.body.appendChild(box);\n\n        window.addEventListener('message', e => {\n          if (e.origin !== '${frontendUrl}') return;\n          if (e.data.type === 'RESIZE_WIDGET') box.style.height = e.data.height + 'px';\n          if (e.data.type === 'CLOSE_WIDGET')  box.style.display = 'none';\n          if (e.data.type === 'OPEN_WIDGET')   box.style.display = 'block';\n        });\n      })\n      .catch(err => console.error('AI Chat Widget load failed:', err));\n  }\n\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', createWidget);\n  } else {\n    createWidget();\n  }\n})();`.trim();\n}\n\nexport { router as widgetLoaderRoutes };\n"],"mappings":"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","ignoreList":[]}