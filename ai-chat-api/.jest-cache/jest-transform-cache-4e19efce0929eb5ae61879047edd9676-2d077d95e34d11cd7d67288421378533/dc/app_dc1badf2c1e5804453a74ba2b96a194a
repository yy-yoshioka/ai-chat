9dff32d52de93613c50510412ba16d9a
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const dotenv_1 = __importDefault(require("dotenv"));
const cookie_parser_1 = __importDefault(require("cookie-parser"));
const cors_1 = __importDefault(require("cors"));
const helmet_1 = __importDefault(require("helmet"));
const metrics_1 = require("./middleware/metrics");
const auth_1 = __importDefault(require("./routes/auth"));
const faqs_1 = __importDefault(require("./routes/faqs"));
const chat_1 = __importDefault(require("./routes/chat"));
const admin_1 = __importDefault(require("./routes/admin"));
const widgets_1 = __importDefault(require("./routes/widgets"));
const widgetLoader_1 = require("./routes/widgetLoader");
const prisma_1 = require("./lib/prisma");
const embed_1 = require("./routes/embed");
const analytics_1 = require("./routes/analytics");
const translation_1 = require("./routes/translation");
const billing_1 = require("./routes/billing");
const companies_1 = require("./routes/companies");
const organizations_1 = __importDefault(require("./routes/organizations"));
const users_1 = __importDefault(require("./routes/users"));
const dashboard_1 = __importDefault(require("./routes/dashboard"));
const reports_1 = __importDefault(require("./routes/reports"));
const knowledge_base_1 = __importDefault(require("./routes/knowledge-base"));
const training_1 = __importDefault(require("./routes/training"));
const settings_1 = __importDefault(require("./routes/settings"));
const webhooks_1 = __importDefault(require("./routes/webhooks"));
const status_1 = __importDefault(require("./routes/status"));
const dataRetention_1 = __importDefault(require("./routes/dataRetention"));
const security_1 = __importDefault(require("./routes/security"));
// Load environment variables
dotenv_1.default.config();
// Initialize Express app
const app = (0, express_1.default)();
// Add metrics middleware early
app.use(metrics_1.metricsMiddleware);
// Security headers (except for widget loader which needs to be embeddable)
app.use('/widget-loader', (req, res, next) => {
    // Allow widget loader to be embedded in any site
    res.removeHeader('X-Frame-Options');
    next();
});
app.use((0, helmet_1.default)({
    frameguard: { action: 'sameorigin' }, // Default frame protection
}));
// CORS middleware with different configs for different routes
app.use('/api/widgets/:widgetKey', (0, cors_1.default)({
    origin: '*', // Allow any origin for public widget config
    methods: ['GET'],
    allowedHeaders: ['Content-Type'],
}));
app.use('/api/chat/widget', (0, cors_1.default)({
    origin: '*', // Allow any origin for widget chat
    methods: ['POST'],
    allowedHeaders: ['Content-Type', 'X-Widget-Key'],
}));
app.use('/widget-loader', (0, cors_1.default)({
    origin: '*', // Allow any origin for widget loader
    methods: ['GET'],
    allowedHeaders: ['Content-Type'],
}));
// Default CORS for admin/auth routes
app.use((0, cors_1.default)({
    origin: [
        'http://localhost:3000',
        process.env.FRONTEND_URL || 'http://localhost:3000',
    ], // Your frontend URL(s)
    credentials: true, // Allow cookies to be sent with requests
    methods: ['GET', 'POST', 'PUT', 'DELETE'],
    allowedHeaders: ['Content-Type', 'Authorization'],
}));
// Middleware
app.use(express_1.default.json());
app.use((0, cookie_parser_1.default)());
// Routes
app.get('/', (_req, res) => {
    res.send('Hello from Express + TypeScript!');
});
// Widget loader routes (serve JS files)
app.use('/widget-loader', widgetLoader_1.widgetLoaderRoutes);
// API routes
app.use('/api/auth', auth_1.default);
app.use('/api/faqs', faqs_1.default);
app.use('/api/chat', chat_1.default);
app.use('/api/admin', admin_1.default);
app.use('/api/widgets', widgets_1.default);
app.use('/api/billing', billing_1.billingRoutes);
app.use('/api/embed', embed_1.embedRoutes);
app.use('/api/analytics', analytics_1.analyticsRoutes);
app.use('/api/translation', translation_1.translationRoutes);
app.use('/api/companies', companies_1.companyRoutes);
app.use('/api/organizations', organizations_1.default);
app.use('/api/users', users_1.default);
app.use('/api/dashboard', dashboard_1.default);
app.use('/api/reports', reports_1.default);
app.use('/api', knowledge_base_1.default);
app.use('/api', training_1.default);
app.use('/api/settings', settings_1.default);
app.use('/api/webhooks', webhooks_1.default);
app.use('/api/status', status_1.default);
app.use('/api/data-retention', dataRetention_1.default);
app.use('/api/security', security_1.default);
app.use('/v1/settings', settings_1.default);
app.use('/v1/organizations', organizations_1.default);
app.use('/v1/widgets', widgets_1.default);
// Legacy routes (backwards compatibility)
app.use('/auth', auth_1.default);
app.use('/faqs', faqs_1.default);
app.use('/chat', chat_1.default);
app.use('/admin', admin_1.default);
// For checking that Prisma is connected
app.get('/debug/db', (_req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        // Count users in the database
        const userCount = yield prisma_1.prisma.user.count();
        const widgetCount = yield prisma_1.prisma.widget.count();
        const companyCount = yield prisma_1.prisma.company.count();
        res.json({
            message: 'Database connection working',
            userCount,
            widgetCount,
            companyCount,
        });
    }
    catch (error) {
        console.error('Database error:', error);
        res.status(500).json({ message: 'Database connection error' });
    }
}));
// ✅ [A] ヘルスチェック
app.get('/health', (_req, res) => res.sendStatus(200));
// Add error tracking middleware at the end
app.use(metrics_1.errorTrackingMiddleware);
exports.default = app;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3l1c3VrZXlvc2hpb2thL3Byb2plY3RzL3lvdXR1YmUvYWktY2hhdC9haS1jaGF0LWFwaS9zcmMvYXBwLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsc0RBQThCO0FBQzlCLG9EQUE0QjtBQUM1QixrRUFBeUM7QUFDekMsZ0RBQXdCO0FBQ3hCLG9EQUE0QjtBQUM1QixrREFHOEI7QUFDOUIseURBQXVDO0FBQ3ZDLHlEQUFzQztBQUN0Qyx5REFBdUM7QUFDdkMsMkRBQXlDO0FBQ3pDLCtEQUE2QztBQUM3Qyx3REFBMkQ7QUFDM0QseUNBQXNDO0FBQ3RDLDBDQUE2QztBQUM3QyxrREFBcUQ7QUFDckQsc0RBQXlEO0FBQ3pELDhDQUFpRDtBQUNqRCxrREFBbUQ7QUFDbkQsMkVBQXlEO0FBQ3pELDJEQUF5QztBQUN6QyxtRUFBaUQ7QUFDakQsK0RBQTZDO0FBQzdDLDZFQUEwRDtBQUMxRCxpRUFBK0M7QUFDL0MsaUVBQStDO0FBQy9DLGlFQUErQztBQUMvQyw2REFBMkM7QUFDM0MsMkVBQXlEO0FBQ3pELGlFQUErQztBQUUvQyw2QkFBNkI7QUFDN0IsZ0JBQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUVoQix5QkFBeUI7QUFDekIsTUFBTSxHQUFHLEdBQUcsSUFBQSxpQkFBTyxHQUFFLENBQUM7QUFFdEIsK0JBQStCO0FBQy9CLEdBQUcsQ0FBQyxHQUFHLENBQUMsMkJBQWlCLENBQUMsQ0FBQztBQUUzQiwyRUFBMkU7QUFDM0UsR0FBRyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7SUFDM0MsaURBQWlEO0lBQ2pELEdBQUcsQ0FBQyxZQUFZLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUNwQyxJQUFJLEVBQUUsQ0FBQztBQUNULENBQUMsQ0FBQyxDQUFDO0FBRUgsR0FBRyxDQUFDLEdBQUcsQ0FDTCxJQUFBLGdCQUFNLEVBQUM7SUFDTCxVQUFVLEVBQUUsRUFBRSxNQUFNLEVBQUUsWUFB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RyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBTyxJQUFJLEVBQUUsR0FBRyxFQUFFLEVBQUU7SUFDdkMsSUFBSSxDQUFDO1FBQ0gsOEJBQThCO1FBQzlCLE1BQU0sU0FBUyxHQUFHLE1BQU0sZUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUM1QyxNQUFNLFdBQVcsR0FBRyxNQUFNLGVBQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDaEQsTUFBTSxZQUFZLEdBQUcsTUFBTSxlQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRWxELEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDUCxPQUFPLEVBQUUsNkJBQTZCO1lBQ3RDLFNBQVM7WUFDVCxXQUFXO1lBQ1gsWUFBWTtTQUNiLENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN4QyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxDQUFDLENBQUM7SUFDakUsQ0FBQztBQUNILENBQUMsQ0FBQSxDQUFDLENBQUM7QUFFSCxnQkFBZ0I7QUFDaEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFFdkQsMkNBQTJDO0FBQzNDLEdBQUcsQ0FBQyxHQUFHLENBQUMsaUNBQXVCLENBQUMsQ0FBQztBQUVqQyxrQkFBZSxHQUFHLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL3l1c3VrZXlvc2hpb2thL3Byb2plY3RzL3lvdXR1YmUvYWktY2hhdC9haS1jaGF0LWFwaS9zcmMvYXBwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGRvdGVudiBmcm9tICdkb3RlbnYnO1xuaW1wb3J0IGNvb2tpZVBhcnNlciBmcm9tICdjb29raWUtcGFyc2VyJztcbmltcG9ydCBjb3JzIGZyb20gJ2NvcnMnO1xuaW1wb3J0IGhlbG1ldCBmcm9tICdoZWxtZXQnO1xuaW1wb3J0IHtcbiAgbWV0cmljc01pZGRsZXdhcmUsXG4gIGVycm9yVHJhY2tpbmdNaWRkbGV3YXJlLFxufSBmcm9tICcuL21pZGRsZXdhcmUvbWV0cmljcyc7XG5pbXBvcnQgYXV0aFJvdXRlcyBmcm9tICcuL3JvdXRlcy9hdXRoJztcbmltcG9ydCBmYXFSb3V0ZXMgZnJvbSAnLi9yb3V0ZXMvZmFxcyc7XG5pbXBvcnQgY2hhdFJvdXRlcyBmcm9tICcuL3JvdXRlcy9jaGF0JztcbmltcG9ydCBhZG1pblJvdXRlcyBmcm9tICcuL3JvdXRlcy9hZG1pbic7XG5pbXBvcnQgd2lkZ2V0c1JvdXRlcyBmcm9tICcuL3JvdXRlcy93aWRnZXRzJztcbmltcG9ydCB7IHdpZGdldExvYWRlclJvdXRlcyB9IGZyb20gJy4vcm91dGVzL3dpZGdldExvYWRlcic7XG5pbXBvcnQgeyBwcmlzbWEgfSBmcm9tICcuL2xpYi9wcmlzbWEnO1xuaW1wb3J0IHsgZW1iZWRSb3V0ZXMgfSBmcm9tICcuL3JvdXRlcy9lbWJlZCc7XG5pbXBvcnQgeyBhbmFseXRpY3NSb3V0ZXMgfSBmcm9tICcuL3JvdXRlcy9hbmFseXRpY3MnO1xuaW1wb3J0IHsgdHJhbnNsYXRpb25Sb3V0ZXMgfSBmcm9tICcuL3JvdXRlcy90cmFuc2xhdGlvbic7XG5pbXBvcnQgeyBiaWxsaW5nUm91dGVzIH0gZnJvbSAnLi9yb3V0ZXMvYmlsbGluZyc7XG5pbXBvcnQgeyBjb21wYW55Um91dGVzIH0gZnJvbSAnLi9yb3V0ZXMvY29tcGFuaWVzJztcbmltcG9ydCBvcmdhbml6YXRpb25zUm91dGVzIGZyb20gJy4vcm91dGVzL29yZ2FuaXphdGlvbnMnO1xuaW1wb3J0IHVzZXJzUm91dGVzIGZyb20gJy4vcm91dGVzL3VzZXJzJztcbmltcG9ydCBkYXNoYm9hcmRSb3V0ZXMgZnJvbSAnLi9yb3V0ZXMvZGFzaGJvYXJkJztcbmltcG9ydCByZXBvcnRzUm91dGVzIGZyb20gJy4vcm91dGVzL3JlcG9ydHMnO1xuaW1wb3J0IGtub3dsZWRnZUJhc2VSb3V0ZXMgZnJvbSAnLi9yb3V0ZXMva25vd2xlZGdlLWJhc2UnO1xuaW1wb3J0IHRyYWluaW5nUm91dGVzIGZyb20gJy4vcm91dGVzL3RyYWluaW5nJztcbmltcG9ydCBzZXR0aW5nc1JvdXRlcyBmcm9tICcuL3JvdXRlcy9zZXR0aW5ncyc7XG5pbXBvcnQgd2ViaG9va3NSb3V0ZXMgZnJvbSAnLi9yb3V0ZXMvd2ViaG9va3MnO1xuaW1wb3J0IHN0YXR1c1JvdXRlcyBmcm9tICcuL3JvdXRlcy9zdGF0dXMnO1xuaW1wb3J0IGRhdGFSZXRlbnRpb25Sb3V0ZXMgZnJvbSAnLi9yb3V0ZXMvZGF0YVJldGVudGlvbic7XG5pbXBvcnQgc2VjdXJpdHlSb3V0ZXMgZnJvbSAnLi9yb3V0ZXMvc2VjdXJpdHknO1xuXG4vLyBMb2FkIGVudmlyb25tZW50IHZhcmlhYmxlc1xuZG90ZW52LmNvbmZpZygpO1xuXG4vLyBJbml0aWFsaXplIEV4cHJlc3MgYXBwXG5jb25zdCBhcHAgPSBleHByZXNzKCk7XG5cbi8vIEFkZCBtZXRyaWNzIG1pZGRsZXdhcmUgZWFybHlcbmFwcC51c2UobWV0cmljc01pZGRsZXdhcmUpO1xuXG4vLyBTZWN1cml0eSBoZWFkZXJzIChleGNlcHQgZm9yIHdpZGdldCBsb2FkZXIgd2hpY2ggbmVlZHMgdG8gYmUgZW1iZWRkYWJsZSlcbmFwcC51c2UoJy93aWRnZXQtbG9hZGVyJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIC8vIEFsbG93IHdpZGdldCBsb2FkZXIgdG8gYmUgZW1iZWRkZWQgaW4gYW55IHNpdGVcbiAgcmVzLnJlbW92ZUhlYWRlcignWC1GcmFtZS1PcHRpb25zJyk7XG4gIG5leHQoKTtcbn0pO1xuXG5hcHAudXNlKFxuICBoZWxtZXQoe1xuICAgIGZyYW1lZ3VhcmQ6IHsgYWN0aW9uOiAnc2FtZW9yaWdpbicgfSwgLy8gRGVmYXVsdCBmcmFtZSBwcm90ZWN0aW9uXG4gIH0pXG4pO1xuXG4vLyBDT1JTIG1pZGRsZXdhcmUgd2l0aCBkaWZmZXJlbnQgY29uZmlncyBmb3IgZGlmZmVyZW50IHJvdXRlc1xuYXBwLnVzZShcbiAgJy9hcGkvd2lkZ2V0cy86d2lkZ2V0S2V5JyxcbiAgY29ycyh7XG4gICAgb3JpZ2luOiAnKicsIC8vIEFsbG93IGFueSBvcmlnaW4gZm9yIHB1YmxpYyB3aWRnZXQgY29uZmlnXG4gICAgbWV0aG9kczogWydHRVQnXSxcbiAgICBhbGxvd2VkSGVhZGVyczogWydDb250ZW50LVR5cGUnXSxcbiAgfSlcbik7XG5cbmFwcC51c2UoXG4gICcvYXBpL2NoYXQvd2lkZ2V0JyxcbiAgY29ycyh7XG4gICAgb3JpZ2luOiAnKicsIC8vIEFsbG93IGFueSBvcmlnaW4gZm9yIHdpZGdldCBjaGF0XG4gICAgbWV0aG9kczogWydQT1NUJ10sXG4gICAgYWxsb3dlZEhlYWRlcnM6IFsnQ29udGVudC1UeXBlJywgJ1gtV2lkZ2V0LUtleSddLFxuICB9KVxuKTtcblxuYXBwLnVzZShcbiAgJy93aWRnZXQtbG9hZGVyJyxcbiAgY29ycyh7XG4gICAgb3JpZ2luOiAnKicsIC8vIEFsbG93IGFueSBvcmlnaW4gZm9yIHdpZGdldCBsb2FkZXJcbiAgICBtZXRob2RzOiBbJ0dFVCddLFxuICAgIGFsbG93ZWRIZWFkZXJzOiBbJ0NvbnRlbnQtVHlwZSddLFxuICB9KVxuKTtcblxuLy8gRGVmYXVsdCBDT1JTIGZvciBhZG1pbi9hdXRoIHJvdXRlc1xuYXBwLnVzZShcbiAgY29ycyh7XG4gICAgb3JpZ2luOiBbXG4gICAgICAnaHR0cDovL2xvY2FsaG9zdDozMDAwJyxcbiAgICAgIHByb2Nlc3MuZW52LkZST05URU5EX1VSTCB8fCAnaHR0cDovL2xvY2FsaG9zdDozMDAwJyxcbiAgICBdLCAvLyBZb3VyIGZyb250ZW5kIFVSTChzKVxuICAgIGNyZWRlbnRpYWxzOiB0cnVlLCAvLyBBbGxvdyBjb29raWVzIHRvIGJlIHNlbnQgd2l0aCByZXF1ZXN0c1xuICAgIG1ldGhvZHM6IFsnR0VUJywgJ1BPU1QnLCAnUFVUJywgJ0RFTEVURSddLFxuICAgIGFsbG93ZWRIZWFkZXJzOiBbJ0NvbnRlbnQtVHlwZScsICdBdXRob3JpemF0aW9uJ10sXG4gIH0pXG4pO1xuXG4vLyBNaWRkbGV3YXJlXG5hcHAudXNlKGV4cHJlc3MuanNvbigpKTtcbmFwcC51c2UoY29va2llUGFyc2VyKCkpO1xuXG4vLyBSb3V0ZXNcbmFwcC5nZXQoJy8nLCAoX3JlcSwgcmVzKSA9PiB7XG4gIHJlcy5zZW5kKCdIZWxsbyBmcm9tIEV4cHJlc3MgKyBUeXBlU2NyaXB0IScpO1xufSk7XG5cbi8vIFdpZGdldCBsb2FkZXIgcm91dGVzIChzZXJ2ZSBKUyBmaWxlcylcbmFwcC51c2UoJy93aWRnZXQtbG9hZGVyJywgd2lkZ2V0TG9hZGVyUm91dGVzKTtcblxuLy8gQVBJIHJvdXRlc1xuYXBwLnVzZSgnL2FwaS9hdXRoJywgYXV0aFJvdXRlcyk7XG5hcHAudXNlKCcvYXBpL2ZhcXMnLCBmYXFSb3V0ZXMpO1xuYXBwLnVzZSgnL2FwaS9jaGF0JywgY2hhdFJvdXRlcyk7XG5hcHAudXNlKCcvYXBpL2FkbWluJywgYWRtaW5Sb3V0ZXMpO1xuYXBwLnVzZSgnL2FwaS93aWRnZXRzJywgd2lkZ2V0c1JvdXRlcyk7XG5hcHAudXNlKCcvYXBpL2JpbGxpbmcnLCBiaWxsaW5nUm91dGVzKTtcbmFwcC51c2UoJy9hcGkvZW1iZWQnLCBlbWJlZFJvdXRlcyk7XG5hcHAudXNlKCcvYXBpL2FuYWx5dGljcycsIGFuYWx5dGljc1JvdXRlcyk7XG5hcHAudXNlKCcvYXBpL3RyYW5zbGF0aW9uJywgdHJhbnNsYXRpb25Sb3V0ZXMpO1xuYXBwLnVzZSgnL2FwaS9jb21wYW5pZXMnLCBjb21wYW55Um91dGVzKTtcbmFwcC51c2UoJy9hcGkvb3JnYW5pemF0aW9ucycsIG9yZ2FuaXphdGlvbnNSb3V0ZXMpO1xuYXBwLnVzZSgnL2FwaS91c2VycycsIHVzZXJzUm91dGVzKTtcbmFwcC51c2UoJy9hcGkvZGFzaGJvYXJkJywgZGFzaGJvYXJkUm91dGVzKTtcbmFwcC51c2UoJy9hcGkvcmVwb3J0cycsIHJlcG9ydHNSb3V0ZXMpO1xuYXBwLnVzZSgnL2FwaScsIGtub3dsZWRnZUJhc2VSb3V0ZXMpO1xuYXBwLnVzZSgnL2FwaScsIHRyYWluaW5nUm91dGVzKTtcbmFwcC51c2UoJy9hcGkvc2V0dGluZ3MnLCBzZXR0aW5nc1JvdXRlcyk7XG5hcHAudXNlKCcvYXBpL3dlYmhvb2tzJywgd2ViaG9va3NSb3V0ZXMpO1xuYXBwLnVzZSgnL2FwaS9zdGF0dXMnLCBzdGF0dXNSb3V0ZXMpO1xuYXBwLnVzZSgnL2FwaS9kYXRhLXJldGVudGlvbicsIGRhdGFSZXRlbnRpb25Sb3V0ZXMpO1xuYXBwLnVzZSgnL2FwaS9zZWN1cml0eScsIHNlY3VyaXR5Um91dGVzKTtcbmFwcC51c2UoJy92MS9zZXR0aW5ncycsIHNldHRpbmdzUm91dGVzKTtcbmFwcC51c2UoJy92MS9vcmdhbml6YXRpb25zJywgb3JnYW5pemF0aW9uc1JvdXRlcyk7XG5hcHAudXNlKCcvdjEvd2lkZ2V0cycsIHdpZGdldHNSb3V0ZXMpO1xuXG4vLyBMZWdhY3kgcm91dGVzIChiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSlcbmFwcC51c2UoJy9hdXRoJywgYXV0aFJvdXRlcyk7XG5hcHAudXNlKCcvZmFxcycsIGZhcVJvdXRlcyk7XG5hcHAudXNlKCcvY2hhdCcsIGNoYXRSb3V0ZXMpO1xuYXBwLnVzZSgnL2FkbWluJywgYWRtaW5Sb3V0ZXMpO1xuXG4vLyBGb3IgY2hlY2tpbmcgdGhhdCBQcmlzbWEgaXMgY29ubmVjdGVkXG5hcHAuZ2V0KCcvZGVidWcvZGInLCBhc3luYyAoX3JlcSwgcmVzKSA9PiB7XG4gIHRyeSB7XG4gICAgLy8gQ291bnQgdXNlcnMgaW4gdGhlIGRhdGFiYXNlXG4gICAgY29uc3QgdXNlckNvdW50ID0gYXdhaXQgcHJpc21hLnVzZXIuY291bnQoKTtcbiAgICBjb25zdCB3aWRnZXRDb3VudCA9IGF3YWl0IHByaXNtYS53aWRnZXQuY291bnQoKTtcbiAgICBjb25zdCBjb21wYW55Q291bnQgPSBhd2FpdCBwcmlzbWEuY29tcGFueS5jb3VudCgpO1xuXG4gICAgcmVzLmpzb24oe1xuICAgICAgbWVzc2FnZTogJ0RhdGFiYXNlIGNvbm5lY3Rpb24gd29ya2luZycsXG4gICAgICB1c2VyQ291bnQsXG4gICAgICB3aWRnZXRDb3VudCxcbiAgICAgIGNvbXBhbnlDb3VudCxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdEYXRhYmFzZSBlcnJvcjonLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiAnRGF0YWJhc2UgY29ubmVjdGlvbiBlcnJvcicgfSk7XG4gIH1cbn0pO1xuXG4vLyDinIUgW0FdIOODmOODq+OCueODgeOCp+ODg+OCr1xuYXBwLmdldCgnL2hlYWx0aCcsIChfcmVxLCByZXMpID0+IHJlcy5zZW5kU3RhdHVzKDIwMCkpO1xuXG4vLyBBZGQgZXJyb3IgdHJhY2tpbmcgbWlkZGxld2FyZSBhdCB0aGUgZW5kXG5hcHAudXNlKGVycm9yVHJhY2tpbmdNaWRkbGV3YXJlKTtcblxuZXhwb3J0IGRlZmF1bHQgYXBwO1xuIl0sInZlcnNpb24iOjN9