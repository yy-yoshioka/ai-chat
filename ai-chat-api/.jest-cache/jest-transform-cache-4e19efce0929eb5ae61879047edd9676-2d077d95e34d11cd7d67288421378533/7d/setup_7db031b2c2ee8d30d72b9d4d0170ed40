dbf824f23f5f7288bcd1a69832672af7
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.mockAuthUser = void 0;
// Mock Prisma
jest.mock('../src/lib/prisma');
// Mock Redis
jest.mock('ioredis');
// Mock services
jest.mock('../src/services/widgetService');
jest.mock('../src/services/userService');
jest.mock('../src/services/organizationService');
jest.mock('../src/services/chatService');
jest.mock('../src/services/knowledgeBaseService');
// Mock logger to reduce noise in tests
jest.mock('../src/lib/logger', () => ({
    logger: {
        info: jest.fn(),
        error: jest.fn(),
        warn: jest.fn(),
        debug: jest.fn(),
    },
}));
// Mock OpenAI
jest.mock('openai', () => ({
    default: jest.fn().mockImplementation(() => ({
        chat: {
            completions: {
                create: jest.fn().mockResolvedValue({
                    choices: [
                        {
                            message: {
                                content: 'Mock AI response',
                                role: 'assistant',
                            },
                        },
                    ],
                }),
            },
        },
        embeddings: {
            create: jest.fn().mockResolvedValue({
                data: [
                    {
                        embedding: new Array(1536).fill(0.1),
                    },
                ],
            }),
        },
    })),
}));
// Mock Stripe
jest.mock('stripe', () => ({
    default: jest.fn().mockImplementation(() => ({
        customers: {
            create: jest.fn().mockResolvedValue({ id: 'cus_test' }),
            retrieve: jest.fn().mockResolvedValue({ id: 'cus_test' }),
            update: jest.fn().mockResolvedValue({ id: 'cus_test' }),
        },
        prices: {
            list: jest.fn().mockResolvedValue({
                data: [
                    {
                        id: 'price_test',
                        product: 'prod_test',
                        unit_amount: 1000,
                        currency: 'usd',
                        recurring: { interval: 'month' },
                    },
                ],
            }),
        },
        subscriptions: {
            create: jest.fn().mockResolvedValue({ id: 'sub_test' }),
            retrieve: jest.fn().mockResolvedValue({ id: 'sub_test' }),
            update: jest.fn().mockResolvedValue({ id: 'sub_test' }),
            cancel: jest.fn().mockResolvedValue({ id: 'sub_test' }),
        },
        checkout: {
            sessions: {
                create: jest.fn().mockResolvedValue({
                    id: 'cs_test',
                    url: 'https://checkout.stripe.com/test',
                }),
            },
        },
        billingPortal: {
            sessions: {
                create: jest
                    .fn()
                    .mockResolvedValue({ url: 'https://billing.stripe.com/test' }),
            },
        },
        webhookEndpoints: {
            create: jest.fn().mockResolvedValue({ id: 'we_test' }),
        },
    })),
}));
// Mock SendGrid
jest.mock('@sendgrid/mail', () => ({
    setApiKey: jest.fn(),
    send: jest.fn().mockResolvedValue([{}]),
}));
// Mock Qdrant
jest.mock('@qdrant/js-client-rest', () => ({
    QdrantClient: jest.fn().mockImplementation(() => ({
        createCollection: jest.fn().mockResolvedValue(true),
        getCollection: jest.fn().mockResolvedValue({ status: 'green' }),
        upsert: jest.fn().mockResolvedValue({ operation_id: 1 }),
        search: jest.fn().mockResolvedValue({
            result: [
                {
                    id: 'vec-1',
                    score: 0.95,
                    payload: {
                        content: 'Test content',
                        metadata: {},
                    },
                },
            ],
        }),
        delete: jest.fn().mockResolvedValue({ operation_id: 1 }),
    })),
}));
// Mock AWS SDK
jest.mock('@aws-sdk/client-s3', () => ({
    S3Client: jest.fn(),
    PutObjectCommand: jest.fn(),
    GetObjectCommand: jest.fn(),
    DeleteObjectCommand: jest.fn(),
}));
// Mock Socket.IO
jest.mock('socket.io', () => {
    const mockSocket = {
        id: 'test-socket-id',
        emit: jest.fn(),
        on: jest.fn(),
        join: jest.fn(),
        leave: jest.fn(),
        disconnect: jest.fn(),
    };
    const mockIo = {
        on: jest.fn((event, handler) => {
            if (event === 'connection') {
                // Simulate a connection
                setImmediate(() => handler(mockSocket));
            }
        }),
        emit: jest.fn(),
        to: jest.fn(() => mockIo),
        in: jest.fn(() => mockIo),
        sockets: {
            sockets: new Map([[mockSocket.id, mockSocket]]),
        },
    };
    return {
        Server: jest.fn(() => mockIo),
    };
});
// Set up test environment
require("reflect-metadata");
const util_1 = require("util");
// Set environment variables for tests
process.env.NODE_ENV = 'test';
process.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/test';
process.env.JWT_SECRET = 'test-secret-key';
process.env.STRIPE_SECRET_KEY = 'sk_test_mock';
process.env.SENDGRID_API_KEY = 'SG.test-key';
process.env.QDRANT_URL = 'http://localhost:6333';
process.env.QDRANT_API_KEY = 'test-qdrant-key';
process.env.AWS_ACCESS_KEY_ID = 'test-aws-key';
process.env.AWS_SECRET_ACCESS_KEY = 'test-aws-secret';
process.env.AWS_REGION = 'us-east-1';
process.env.S3_BUCKET_NAME = 'test-bucket';
process.env.REDIS_URL = 'redis://localhost:6379';
process.env.OPENAI_API_KEY = 'sk-test-mock';
// Mock global objects
global.TextEncoder = util_1.TextEncoder;
global.TextDecoder = util_1.TextDecoder;
// Clean up after each test
afterEach(() => {
    jest.clearAllMocks();
});
// Global test timeout
jest.setTimeout(30000);
// Test helpers
exports.mockAuthUser = {
    id: 'test-user-id',
    email: 'test@example.com',
    organizationId: 'test-org-id',
    roles: ['admin'],
};
// Mock date for consistent testing
const mockDate = new Date('2024-01-01T00:00:00Z');
jest.useFakeTimers();
jest.setSystemTime(mockDate);
// Helper to reset all mocks
global.resetAllMocks = () => {
    jest.clearAllMocks();
    jest.clearAllTimers();
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3l1c3VrZXlvc2hpb2thL3Byb2plY3RzL3lvdXR1YmUvYWktY2hhdC9haS1jaGF0LWFwaS90ZXN0cy9zZXR1cC50cyIsIm1hcHBpbmdzIjoiOzs7QUF1QkEsY0FBYztBQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUUvQixhQUFhO0FBQ2IsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUVyQixnQkFBZ0I7QUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0FBQzNDLElBQUksQ0FBQyxJQUFJLENBQUMsNkJBQTZCLENBQUMsQ0FBQztBQUN6QyxJQUFJLENBQUMsSUFBSSxDQUFDLHFDQUFxQyxDQUFDLENBQUM7QUFDakQsSUFBSSxDQUFDLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0FBQ3pDLElBQUksQ0FBQyxJQUFJLENBQUMsc0NBQXNDLENBQUMsQ0FBQztBQUVsRCx1Q0FBdUM7QUFDdkMsSUFBSSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3BDLE1BQU0sRUFBRTtRQUNOLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2YsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDaEIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtLQUNqQjtDQUNGLENBQUMsQ0FBQyxDQUFDO0FBRUosY0FBYztBQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDekIsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLElBQUksRUFBRTtZQUNKLFdBQVcsRUFBRTtnQkFDWCxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFp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QUFXLENBQUM7QUFDakMsTUFBTSxDQUFDLFdBQVcsR0FBRyxrQkFBa0IsQ0FBQztBQXlLeEMsMkJBQTJCO0FBQzNCLFNBQVMsQ0FBQyxHQUFHLEVBQUU7SUFDYixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7QUFDdkIsQ0FBQyxDQUFDLENBQUM7QUFFSCxzQkFBc0I7QUFDdEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUV2QixlQUFlO0FBQ0YsUUFBQSxZQUFZLEdBQUc7SUFDMUIsRUFBRSxFQUFFLGNBQWM7SUFDbEIsS0FBSyxFQUFFLGtCQUFrQjtJQUN6QixjQUFjLEVBQUUsYUFBYTtJQUM3QixLQUFLLEVBQUUsQ0FBQyxPQUFPLENBQUM7Q0FDakIsQ0FBQztBQUVGLG1DQUFtQztBQUNuQyxNQUFNLFFBQVEsR0FBRyxJQUFJLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2xELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUNyQixJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRTdCLDRCQUE0QjtBQUMzQixNQUFjLENBQUMsYUFBYSxHQUFHLEdBQUcsRUFBRTtJQUNuQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDckIsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0FBQ3hCLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMveXVzdWtleW9zaGlva2EvcHJvamVjdHMveW91dHViZS9haS1jaGF0L2FpLWNoYXQtYXBpL3Rlc3RzL3NldHVwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIFNldCB1cCB0ZXN0IGVudmlyb25tZW50XG5pbXBvcnQgJ3JlZmxlY3QtbWV0YWRhdGEnO1xuaW1wb3J0IHsgVGV4dEVuY29kZXIsIFRleHREZWNvZGVyIH0gZnJvbSAndXRpbCc7XG5cbi8vIFNldCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgZm9yIHRlc3RzXG5wcm9jZXNzLmVudi5OT0RFX0VOViA9ICd0ZXN0JztcbnByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCA9ICdwb3N0Z3Jlc3FsOi8vdGVzdDp0ZXN0QGxvY2FsaG9zdDo1NDMyL3Rlc3QnO1xucHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9ICd0ZXN0LXNlY3JldC1rZXknO1xucHJvY2Vzcy5lbnYuU1RSSVBFX1NFQ1JFVF9LRVkgPSAnc2tfdGVzdF9tb2NrJztcbnByb2Nlc3MuZW52LlNFTkRHUklEX0FQSV9LRVkgPSAnU0cudGVzdC1rZXknO1xucHJvY2Vzcy5lbnYuUURSQU5UX1VSTCA9ICdodHRwOi8vbG9jYWxob3N0OjYzMzMnO1xucHJvY2Vzcy5lbnYuUURSQU5UX0FQSV9LRVkgPSAndGVzdC1xZHJhbnQta2V5JztcbnByb2Nlc3MuZW52LkFXU19BQ0NFU1NfS0VZX0lEID0gJ3Rlc3QtYXdzLWtleSc7XG5wcm9jZXNzLmVudi5BV1NfU0VDUkVUX0FDQ0VTU19LRVkgPSAndGVzdC1hd3Mtc2VjcmV0JztcbnByb2Nlc3MuZW52LkFXU19SRUdJT04gPSAndXMtZWFzdC0xJztcbnByb2Nlc3MuZW52LlMzX0JVQ0tFVF9OQU1FID0gJ3Rlc3QtYnVja2V0JztcbnByb2Nlc3MuZW52LlJFRElTX1VSTCA9ICdyZWRpczovL2xvY2FsaG9zdDo2Mzc5JztcbnByb2Nlc3MuZW52Lk9QRU5BSV9BUElfS0VZID0gJ3NrLXRlc3QtbW9jayc7XG5cbi8vIE1vY2sgZ2xvYmFsIG9iamVjdHNcbmdsb2JhbC5UZXh0RW5jb2RlciA9IFRleHRFbmNvZGVyO1xuZ2xvYmFsLlRleHREZWNvZGVyID0gVGV4dERlY29kZXIgYXMgYW55O1xuXG4vLyBNb2NrIFByaXNtYVxuamVzdC5tb2NrKCcuLi9zcmMvbGliL3ByaXNtYScpO1xuXG4vLyBNb2NrIFJlZGlzXG5qZXN0Lm1vY2soJ2lvcmVkaXMnKTtcblxuLy8gTW9jayBzZXJ2aWNlc1xuamVzdC5tb2NrKCcuLi9zcmMvc2VydmljZXMvd2lkZ2V0U2VydmljZScpO1xuamVzdC5tb2NrKCcuLi9zcmMvc2VydmljZXMvdXNlclNlcnZpY2UnKTtcbmplc3QubW9jaygnLi4vc3JjL3NlcnZpY2VzL29yZ2FuaXphdGlvblNlcnZpY2UnKTtcbmplc3QubW9jaygnLi4vc3JjL3NlcnZpY2VzL2NoYXRTZXJ2aWNlJyk7XG5qZXN0Lm1vY2soJy4uL3NyYy9zZXJ2aWNlcy9rbm93bGVkZ2VCYXNlU2VydmljZScpO1xuXG4vLyBNb2NrIGxvZ2dlciB0byByZWR1Y2Ugbm9pc2UgaW4gdGVzdHNcbmplc3QubW9jaygnLi4vc3JjL2xpYi9sb2dnZXInLCAoKSA9PiAoe1xuICBsb2dnZXI6IHtcbiAgICBpbmZvOiBqZXN0LmZuKCksXG4gICAgZXJyb3I6IGplc3QuZm4oKSxcbiAgICB3YXJuOiBqZXN0LmZuKCksXG4gICAgZGVidWc6IGplc3QuZm4oKSxcbiAgfSxcbn0pKTtcblxuLy8gTW9jayBPcGVuQUlcbmplc3QubW9jaygnb3BlbmFpJywgKCkgPT4gKHtcbiAgZGVmYXVsdDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiAoe1xuICAgIGNoYXQ6IHtcbiAgICAgIGNvbXBsZXRpb25zOiB7XG4gICAgICAgIGNyZWF0ZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgICBjaG9pY2VzOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIG1lc3NhZ2U6IHtcbiAgICAgICAgICAgICAgICBjb250ZW50OiAnTW9jayBBSSByZXNwb25zZScsXG4gICAgICAgICAgICAgICAgcm9sZTogJ2Fzc2lzdGFudCcsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIF0sXG4gICAgICAgIH0pLFxuICAgICAgfSxcbiAgICB9LFxuICAgIGVtYmVkZGluZ3M6IHtcbiAgICAgIGNyZWF0ZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgZGF0YTogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIGVtYmVkZGluZzogbmV3IEFycmF5KDE1MzYpLmZpbGwoMC4xKSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfSksXG4gICAgfSxcbiAgfSkpLFxufSkpO1xuXG4vLyBNb2NrIFN0cmlwZVxuamVzdC5tb2NrKCdzdHJpcGUnLCAoKSA9PiAoe1xuICBkZWZhdWx0OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgY3VzdG9tZXJzOiB7XG4gICAgICBjcmVhdGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGlkOiAnY3VzX3Rlc3QnIH0pLFxuICAgICAgcmV0cmlldmU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGlkOiAnY3VzX3Rlc3QnIH0pLFxuICAgICAgdXBkYXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBpZDogJ2N1c190ZXN0JyB9KSxcbiAgICB9LFxuICAgIHByaWNlczoge1xuICAgICAgbGlzdDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgZGF0YTogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIGlkOiAncHJpY2VfdGVzdCcsXG4gICAgICAgICAgICBwcm9kdWN0OiAncHJvZF90ZXN0JyxcbiAgICAgICAgICAgIHVuaXRfYW1vdW50OiAxMDAwLFxuICAgICAgICAgICAgY3VycmVuY3k6ICd1c2QnLFxuICAgICAgICAgICAgcmVjdXJyaW5nOiB7IGludGVydmFsOiAnbW9udGgnIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgIH0pLFxuICAgIH0sXG4gICAgc3Vic2NyaXB0aW9uczoge1xuICAgICAgY3JlYXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBpZDogJ3N1Yl90ZXN0JyB9KSxcbiAgICAgIHJldHJpZXZlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBpZDogJ3N1Yl90ZXN0JyB9KSxcbiAgICAgIHVwZGF0ZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6ICdzdWJfdGVzdCcgfSksXG4gICAgICBjYW5jZWw6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGlkOiAnc3ViX3Rlc3QnIH0pLFxuICAgIH0sXG4gICAgY2hlY2tvdXQ6IHtcbiAgICAgIHNlc3Npb25zOiB7XG4gICAgICAgIGNyZWF0ZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgICBpZDogJ2NzX3Rlc3QnLFxuICAgICAgICAgIHVybDogJ2h0dHBzOi8vY2hlY2tvdXQuc3RyaXBlLmNvbS90ZXN0JyxcbiAgICAgICAgfSksXG4gICAgICB9LFxuICAgIH0sXG4gICAgYmlsbGluZ1BvcnRhbDoge1xuICAgICAgc2Vzc2lvbnM6IHtcbiAgICAgICAgY3JlYXRlOiBqZXN0XG4gICAgICAgICAgLmZuKClcbiAgICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWUoeyB1cmw6ICdodHRwczovL2JpbGxpbmcuc3RyaXBlLmNvbS90ZXN0JyB9KSxcbiAgICAgIH0sXG4gICAgfSxcbiAgICB3ZWJob29rRW5kcG9pbnRzOiB7XG4gICAgICBjcmVhdGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGlkOiAnd2VfdGVzdCcgfSksXG4gICAgfSxcbiAgfSkpLFxufSkpO1xuXG4vLyBNb2NrIFNlbmRHcmlkXG5qZXN0Lm1vY2soJ0BzZW5kZ3JpZC9tYWlsJywgKCkgPT4gKHtcbiAgc2V0QXBpS2V5OiBqZXN0LmZuKCksXG4gIHNlbmQ6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShbe31dKSxcbn0pKTtcblxuLy8gTW9jayBRZHJhbnRcbmplc3QubW9jaygnQHFkcmFudC9qcy1jbGllbnQtcmVzdCcsICgpID0+ICh7XG4gIFFkcmFudENsaWVudDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiAoe1xuICAgIGNyZWF0ZUNvbGxlY3Rpb246IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh0cnVlKSxcbiAgICBnZXRDb2xsZWN0aW9uOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBzdGF0dXM6ICdncmVlbicgfSksXG4gICAgdXBzZXJ0OiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBvcGVyYXRpb25faWQ6IDEgfSksXG4gICAgc2VhcmNoOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgcmVzdWx0OiBbXG4gICAgICAgIHtcbiAgICAgICAgICBpZDogJ3ZlYy0xJyxcbiAgICAgICAgICBzY29yZTogMC45NSxcbiAgICAgICAgICBwYXlsb2FkOiB7XG4gICAgICAgICAgICBjb250ZW50OiAnVGVzdCBjb250ZW50JyxcbiAgICAgICAgICAgIG1ldGFkYXRhOiB7fSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KSxcbiAgICBkZWxldGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IG9wZXJhdGlvbl9pZDogMSB9KSxcbiAgfSkpLFxufSkpO1xuXG4vLyBNb2NrIEFXUyBTREtcbmplc3QubW9jaygnQGF3cy1zZGsvY2xpZW50LXMzJywgKCkgPT4gKHtcbiAgUzNDbGllbnQ6IGplc3QuZm4oKSxcbiAgUHV0T2JqZWN0Q29tbWFuZDogamVzdC5mbigpLFxuICBHZXRPYmplY3RDb21tYW5kOiBqZXN0LmZuKCksXG4gIERlbGV0ZU9iamVjdENvbW1hbmQ6IGplc3QuZm4oKSxcbn0pKTtcblxuLy8gTW9jayBTb2NrZXQuSU9cbmplc3QubW9jaygnc29ja2V0LmlvJywgKCkgPT4ge1xuICBjb25zdCBtb2NrU29ja2V0ID0ge1xuICAgIGlkOiAndGVzdC1zb2NrZXQtaWQnLFxuICAgIGVtaXQ6IGplc3QuZm4oKSxcbiAgICBvbjogamVzdC5mbigpLFxuICAgIGpvaW46IGplc3QuZm4oKSxcbiAgICBsZWF2ZTogamVzdC5mbigpLFxuICAgIGRpc2Nvbm5lY3Q6IGplc3QuZm4oKSxcbiAgfTtcblxuICBjb25zdCBtb2NrSW86IGFueSA9IHtcbiAgICBvbjogamVzdC5mbigoZXZlbnQ6IHN0cmluZywgaGFuZGxlcjogKHNvY2tldDogYW55KSA9PiB2b2lkKSA9PiB7XG4gICAgICBpZiAoZXZlbnQgPT09ICdjb25uZWN0aW9uJykge1xuICAgICAgICAvLyBTaW11bGF0ZSBhIGNvbm5lY3Rpb25cbiAgICAgICAgc2V0SW1tZWRpYXRlKCgpID0+IGhhbmRsZXIobW9ja1NvY2tldCkpO1xuICAgICAgfVxuICAgIH0pLFxuICAgIGVtaXQ6IGplc3QuZm4oKSxcbiAgICB0bzogamVzdC5mbigoKSA9PiBtb2NrSW8pLFxuICAgIGluOiBqZXN0LmZuKCgpID0+IG1vY2tJbyksXG4gICAgc29ja2V0czoge1xuICAgICAgc29ja2V0czogbmV3IE1hcChbW21vY2tTb2NrZXQuaWQsIG1vY2tTb2NrZXRdXSksXG4gICAgfSxcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIFNlcnZlcjogamVzdC5mbigoKSA9PiBtb2NrSW8pLFxuICB9O1xufSk7XG5cbi8vIENsZWFuIHVwIGFmdGVyIGVhY2ggdGVzdFxuYWZ0ZXJFYWNoKCgpID0+IHtcbiAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG59KTtcblxuLy8gR2xvYmFsIHRlc3QgdGltZW91dFxuamVzdC5zZXRUaW1lb3V0KDMwMDAwKTtcblxuLy8gVGVzdCBoZWxwZXJzXG5leHBvcnQgY29uc3QgbW9ja0F1dGhVc2VyID0ge1xuICBpZDogJ3Rlc3QtdXNlci1pZCcsXG4gIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXG4gIG9yZ2FuaXphdGlvbklkOiAndGVzdC1vcmctaWQnLFxuICByb2xlczogWydhZG1pbiddLFxufTtcblxuLy8gTW9jayBkYXRlIGZvciBjb25zaXN0ZW50IHRlc3RpbmdcbmNvbnN0IG1vY2tEYXRlID0gbmV3IERhdGUoJzIwMjQtMDEtMDFUMDA6MDA6MDBaJyk7XG5qZXN0LnVzZUZha2VUaW1lcnMoKTtcbmplc3Quc2V0U3lzdGVtVGltZShtb2NrRGF0ZSk7XG5cbi8vIEhlbHBlciB0byByZXNldCBhbGwgbW9ja3NcbihnbG9iYWwgYXMgYW55KS5yZXNldEFsbE1vY2tzID0gKCkgPT4ge1xuICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgamVzdC5jbGVhckFsbFRpbWVycygpO1xufTtcbiJdLCJ2ZXJzaW9uIjozfQ==