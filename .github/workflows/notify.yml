name: Slack Notify for Commits & PR # Workflow å

on:
  push: # ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒ
    branches: ["**"]
  pull_request:
    types: [opened, reopened, ready_for_review]

jobs:
  slack-notify:
    runs-on: ubuntu-latest

    # GitHub â†’ Slack é€£æºã«æœ€ä½é™å¿…è¦ãª 2 å¤‰æ•°ã‚’ env ã«å±•é–‹
    env:
      SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

    steps:
      # jq ã¯ Ubuntu ã‚¤ãƒ¡ãƒ¼ã‚¸ã«å…¥ã£ã¦ã„ãªã„ã®ã§ 1 è¡Œã§å–å¾—
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # â–¶ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸çµ„ã¿ç«‹ã¦
      - name: Build Slack payload
        id: fmt
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # push ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚³ãƒŸãƒƒãƒˆ â†’ diff ãƒªãƒ³ã‚¯ã‚‚ä»˜ã‘ã‚‹ï¼‰
            TEXT="ğŸ“¦ *Commit pushed* by ${{ github.actor }} â†’ <${{ github.event.compare }}|diff>"
          else
            # pull_request ã‚¤ãƒ™ãƒ³ãƒˆ
            PR_URL=${{ github.event.pull_request.html_url }}
            TITLE=${{ github.event.pull_request.title }}
            TEXT="ğŸ” *PR created* <$PR_URL|${TITLE}> by ${{ github.actor }}"
          fi

          # jq ã§ JSON ã«æ•´å½¢ã—ã¦ outputs ã«æ¸¡ã™
          echo "payload=$(jq -nc \
                --arg c \"$SLACK_CHANNEL_ID\" \
                --arg t \"$TEXT\" \
                '{channel:$c,text:$t}')" >> "$GITHUB_OUTPUT"

      # â–¶ Slack ã¸æŠ•ç¨¿
      - name: Post to Slack
        uses: slackapi/slack-github-action@v1
        with:
          payload: ${{ steps.fmt.outputs.payload }}
        env:
          SLACK_BOT_TOKEN: ${{ env.SLACK_BOT_TOKEN }}
