# .github/workflows/notify.yml
name: Slack Notify for Commits & PR

on:
  push:
    branches: ["**"] # すべてのブランチ
  pull_request:
    types: [opened, reopened, ready_for_review]

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    env: # Secrets を環境変数へ
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}

    steps:
      # jq が不要な構成にしたので install ステップは省略 OK

      - name: Compose Slack message
        id: compose
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            MSG="📦 *Commit pushed* by ${{ github.actor }} -> <${{ github.event.compare }}|diff>"
          else
            MSG="🔍 *PR created* <${{ github.event.pull_request.html_url }}|${{ github.event.pull_request.title }}> by ${{ github.actor }}"
          fi
          echo "SLACK_MESSAGE=$MSG" >> "$GITHUB_ENV"   # 後段で参照できるようにエクスポート

      - name: Post to Slack
        uses: slackapi/slack-github-action@v1
        with:
          channel-id: ${{ env.SLACK_CHANNEL_ID }} # 公式引数
          payload: |
            {
              "text": "${{ env.SLACK_MESSAGE }}"
            }
        env:
          SLACK_BOT_TOKEN: ${{ env.SLACK_BOT_TOKEN }}
