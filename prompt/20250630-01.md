# =====================================================================
#  ğŸš€  Claude Code RUNBOOK  â€“  ai-chat / ai-chat-ui Monorepo
#  (åŸºç‚¹ãƒ–ãƒ©ãƒ³ãƒ: develop)
# =====================================================================
#  ğŸ¯ GLOBAL GOALS
#    1. ã™ã¹ã¦ã® TODO ã‚’ã‚¯ãƒªã‚¢ã—ã¦  yarn lint / yarn build = Error 0
#    2. ä½œæ¥­ã¯ feature/<todo-key> â† develop ã§è¡Œã„ã€PR ã‚‚ develop å‘ã‘
#    3. å„ã‚¹ãƒ†ãƒƒãƒ—ã® START/DONE/FAIL ã¨ PR READY ã‚’ Slack #dev-ci ã«é€šçŸ¥
#
# =====================================================================
#  ğŸ—‚ï¸  REPO STRUCTUREï¼ˆæŠœç²‹ï¼‰
#    ai-chat         â€¦ Express API
#    ai-chat-ui      â€¦ Next.js App Router (BFF)
#      â”œâ”€ app/api/bff/**        â† BFF ãƒ«ãƒ¼ãƒˆ
#      â”œâ”€ app/_schemas/**       â† Zod ã‚¹ã‚­ãƒ¼ãƒå°‚ç”¨
#      â”œâ”€ app/_utils/fetcher.ts â† fetch ãƒ©ãƒƒãƒ‘
#      â””â”€ scripts/slack-notify.sh
#
# =====================================================================
#  âš™ï¸  CLAUDE CODE SETTINGS
#  permissions.json
#  -----------------
#  {
#    "permissions": { "allow": ["Bash(*)","Git(*)","Yarn(*)","Docker(*)","Node(*)"], "deny": [] },
#    "auto_confirm": true
#  }
#
# =====================================================================
#  ğŸ””  SLACK NOTIFY RULE
#    ./scripts/slack-notify.sh "START <todo-key>"
#    ./scripts/slack-notify.sh "DONE  <todo-key>"
#    ./scripts/slack-notify.sh "FAIL  <todo-key> : <stderr>"
#    ./scripts/slack-notify.sh "PR READY <branch>"
#
# =====================================================================
#  ğŸŒ³  GIT WORKFLOW
#    â€¢ ãƒ–ãƒ©ãƒ³ãƒ : feature/<todo-key>  ï¼ˆdevelop ã‹ã‚‰ä½œæˆï¼‰
#    â€¢ Commit : <type>(<scope>): <subject>   ä¾‹) feat(api): dashboard route
#      - type  = feat / fix / refactor / chore / test / docs
#      - scope = api | ui | hook | schema | config | infra
#      - æœ«å°¾ã«ã€Œ#CIã€ã§ GitHub Actions å®Ÿè¡Œ
#
# =====================================================================
#  ğŸ›¡ï¸  CODING RULE DIGEST
#    â€¢ fetch ç›´å‘¼ã³ç¦æ­¢  â†’ å¿…ãš app/_utils/fetcher.ts çµŒç”±
#    â€¢ Zod å®£è¨€          â†’ app/_schemas/** ã®ã¿
#    â€¢ npm / pnpm ç¦æ­¢   â†’ Yarn å›ºå®š
#    â€¢ ESLint            â†’ max-lines-per-function 100 / jsx-max-depth 5
#    â€¢ eslint-disable    â†’ åŸå‰‡ç¦æ­¢
#
# =====================================================================
#  ğŸªœ  TODO ROADMAP  ï¼ˆå…¨ 7 ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
# ---------------------------------------------------------------------
#  â–  Section-1  feat(api): dashboard BFF (Next.js)           <todo-key> dashboard-api
# ---------------------------------------------------------------------
slack-notify START dashboard-api
git checkout -b feature/dashboard-api develop

# â‘  app/_schemas/dashboard.ts è¿½åŠ 
# â‘¡ app/api/bff/dashboard/route.ts å®Ÿè£…
#    - GET
#    - JWT cookie auth
#    - fetchGet(`${API_URL}/dashboard`)
#    - dashboardResponseSchema.safeParse()
#    - 401 / 502 / 500 ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
yarn lint --fix && yarn build
git add app/api/bff/dashboard app/_schemas/dashboard.ts
git commit -m "feat(api): dashboard BFF route #CI"
slack-notify DONE dashboard-api

# ---------------------------------------------------------------------
#  â–  Section-2  feat(api): dashboard Express route           <todo-key> dashboard-express
# ---------------------------------------------------------------------
slack-notify START dashboard-express
git checkout -b feature/dashboard-express develop

# â‘  ai-chat/src/routes/dashboard.ts è¿½åŠ 
#    - authMiddleware + metricsMiddleware
#    - Prisma ã§ totalChats / activeUsers â€¦ é›†è¨ˆ
# â‘¡ src/app.ts ã« `app.use('/api', dashboardRoutes);`
yarn lint --fix && yarn build
git add ai-chat/src/routes/dashboard.ts ai-chat/src/app.ts
git commit -m "feat(api): dashboard Express route #CI"
slack-notify DONE dashboard-express

# ---------------------------------------------------------------------
#  â–  Section-3  feat(api): users CRUD (Next.js BFF)          <todo-key> users-bff
# ---------------------------------------------------------------------
slack-notify START users-bff
git checkout -b feature/users-bff develop

# â‘  app/_schemas/users.ts ã« list / update / invite ã‚¹ã‚­ãƒ¼ãƒè¿½åŠ 
# â‘¡ app/api/bff/users/{route.ts,[id]/route.ts,invite/route.ts}
#    - cookie auth + fetcher
#    - Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
yarn lint --fix && yarn build
git add app/_schemas/users.ts app/api/bff/users
git commit -m "feat(api): users BFF CRUD #CI"
slack-notify DONE users-bff

# ---------------------------------------------------------------------
#  â–  Section-4  feat(api): users CRUD (Express)              <todo-key> users-express
# ---------------------------------------------------------------------
slack-notify START users-express
git checkout -b feature/users-express develop

# â‘  ai-chat/src/routes/users.ts å®Ÿè£…
#    - LIST / PUT / DELETE / POST invite
#    - adminMiddleware + organizationAccessMiddleware
# â‘¡ src/app.ts ã«ç™»éŒ²
yarn lint --fix && yarn build
git add ai-chat/src/routes/users.ts ai-chat/src/app.ts
git commit -m "feat(api): users Express CRUD #CI"
slack-notify DONE users-express

# ---------------------------------------------------------------------
#  â–  Section-5  feat(api): reports suite                     <todo-key> reports-suite
# ---------------------------------------------------------------------
slack-notify START reports-suite
git checkout -b feature/reports-suite develop

# â‘  app/_schemas/reports.ts : reportQuerySchema
# â‘¡ app/api/bff/reports/route.ts : GET & proxy
# â‘¢ ai-chat/src/routes/reports.ts : summary / chart / CSV
yarn lint --fix && yarn build
git add app/_schemas/reports.ts app/api/bff/reports ai-chat/src/routes/reports.ts
git commit -m "feat(api): reports suite #CI"
slack-notify DONE reports-suite

# ---------------------------------------------------------------------
#  â–  Section-6  feat(api): organizations suite               <todo-key> org-suite
# ---------------------------------------------------------------------
slack-notify START org-suite
git checkout -b feature/org-suite develop

# â‘  app/_schemas/organizations.ts ï¼ˆå¿…è¦ãªã‚‰ï¼‰
# â‘¡ app/api/bff/organizations/route.ts : GET stats / PUT update
# â‘¢ ai-chat/src/routes/organizations.ts : ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå®Ÿè£…
yarn lint --fix && yarn build
git add app/_schemas/organizations.ts app/api/bff/organizations ai-chat/src/routes/organizations.ts
git commit -m "feat(api): organizations suite #CI"
slack-notify DONE org-suite

# ---------------------------------------------------------------------
#  â–  Section-7  test(all): integration & e2e                 <todo-key> tests
# ---------------------------------------------------------------------
slack-notify START tests
git checkout -b feature/tests develop

# â‘  Jest + Supertest çµ±åˆãƒ†ã‚¹ãƒˆ (Express)
# â‘¡ MSW / Playwright ãƒ†ã‚¹ãƒˆ (Next.js)
# â‘¢ ã‚«ãƒãƒ¬ãƒƒã‚¸ 80% ä»¥ä¸Š
yarn lint && yarn build && yarn test
git add app/tests ai-chat/tests
git commit -m "test: integration & e2e #CI"
slack-notify DONE tests

# =====================================================================
#  â–  FINALIZE
# ---------------------------------------------------------------------
slack-notify START finalize
git checkout develop
git merge --no-ff feature/dashboard-api \
                    feature/dashboard-express \
                    feature/users-bff \
                    feature/users-express \
                    feature/reports-suite \
                    feature/org-suite \
                    feature/tests

yarn format && yarn lint && yarn build
git commit -am "fix(lint): clear all errors #CI"
git push -u origin develop
gh pr create --base develop --fill
./scripts/slack-notify.sh "PR READY develop"
slack-notify DONE finalize
# =====================================================================
