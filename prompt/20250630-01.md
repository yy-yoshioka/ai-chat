# =====================================================================
#  🚀  Claude Code RUNBOOK  –  ai-chat / ai-chat-ui Monorepo
#  (基点ブランチ: develop)
# =====================================================================
#  🎯 GLOBAL GOALS
#    1. すべての TODO をクリアして  yarn lint / yarn build = Error 0
#    2. 作業は feature/<todo-key> ← develop で行い、PR も develop 向け
#    3. 各ステップの START/DONE/FAIL と PR READY を Slack #dev-ci に通知
#
# =====================================================================
#  🗂️  REPO STRUCTURE（抜粋）
#    ai-chat         … Express API
#    ai-chat-ui      … Next.js App Router (BFF)
#      ├─ app/api/bff/**        ← BFF ルート
#      ├─ app/_schemas/**       ← Zod スキーマ専用
#      ├─ app/_utils/fetcher.ts ← fetch ラッパ
#      └─ scripts/slack-notify.sh
#
# =====================================================================
#  ⚙️  CLAUDE CODE SETTINGS
#  permissions.json
#  -----------------
#  {
#    "permissions": { "allow": ["Bash(*)","Git(*)","Yarn(*)","Docker(*)","Node(*)"], "deny": [] },
#    "auto_confirm": true
#  }
#
# =====================================================================
#  🔔  SLACK NOTIFY RULE
#    ./scripts/slack-notify.sh "START <todo-key>"
#    ./scripts/slack-notify.sh "DONE  <todo-key>"
#    ./scripts/slack-notify.sh "FAIL  <todo-key> : <stderr>"
#    ./scripts/slack-notify.sh "PR READY <branch>"
#
# =====================================================================
#  🌳  GIT WORKFLOW
#    • ブランチ : feature/<todo-key>  （develop から作成）
#    • Commit : <type>(<scope>): <subject>   例) feat(api): dashboard route
#      - type  = feat / fix / refactor / chore / test / docs
#      - scope = api | ui | hook | schema | config | infra
#      - 末尾に「#CI」で GitHub Actions 実行
#
# =====================================================================
#  🛡️  CODING RULE DIGEST
#    • fetch 直呼び禁止  → 必ず app/_utils/fetcher.ts 経由
#    • Zod 宣言          → app/_schemas/** のみ
#    • npm / pnpm 禁止   → Yarn 固定
#    • ESLint            → max-lines-per-function 100 / jsx-max-depth 5
#    • eslint-disable    → 原則禁止
#
# =====================================================================
#  🪜  TODO ROADMAP  （全 7 セクション）
# ---------------------------------------------------------------------
#  ■ Section-1  feat(api): dashboard BFF (Next.js)           <todo-key> dashboard-api
# ---------------------------------------------------------------------
slack-notify START dashboard-api
git checkout -b feature/dashboard-api develop

# ① app/_schemas/dashboard.ts 追加
# ② app/api/bff/dashboard/route.ts 実装
#    - GET
#    - JWT cookie auth
#    - fetchGet(`${API_URL}/dashboard`)
#    - dashboardResponseSchema.safeParse()
#    - 401 / 502 / 500 ハンドリング
yarn lint --fix && yarn build
git add app/api/bff/dashboard app/_schemas/dashboard.ts
git commit -m "feat(api): dashboard BFF route #CI"
slack-notify DONE dashboard-api

# ---------------------------------------------------------------------
#  ■ Section-2  feat(api): dashboard Express route           <todo-key> dashboard-express
# ---------------------------------------------------------------------
slack-notify START dashboard-express
git checkout -b feature/dashboard-express develop

# ① ai-chat/src/routes/dashboard.ts 追加
#    - authMiddleware + metricsMiddleware
#    - Prisma で totalChats / activeUsers … 集計
# ② src/app.ts に `app.use('/api', dashboardRoutes);`
yarn lint --fix && yarn build
git add ai-chat/src/routes/dashboard.ts ai-chat/src/app.ts
git commit -m "feat(api): dashboard Express route #CI"
slack-notify DONE dashboard-express

# ---------------------------------------------------------------------
#  ■ Section-3  feat(api): users CRUD (Next.js BFF)          <todo-key> users-bff
# ---------------------------------------------------------------------
slack-notify START users-bff
git checkout -b feature/users-bff develop

# ① app/_schemas/users.ts に list / update / invite スキーマ追加
# ② app/api/bff/users/{route.ts,[id]/route.ts,invite/route.ts}
#    - cookie auth + fetcher
#    - Zod バリデーション
yarn lint --fix && yarn build
git add app/_schemas/users.ts app/api/bff/users
git commit -m "feat(api): users BFF CRUD #CI"
slack-notify DONE users-bff

# ---------------------------------------------------------------------
#  ■ Section-4  feat(api): users CRUD (Express)              <todo-key> users-express
# ---------------------------------------------------------------------
slack-notify START users-express
git checkout -b feature/users-express develop

# ① ai-chat/src/routes/users.ts 実装
#    - LIST / PUT / DELETE / POST invite
#    - adminMiddleware + organizationAccessMiddleware
# ② src/app.ts に登録
yarn lint --fix && yarn build
git add ai-chat/src/routes/users.ts ai-chat/src/app.ts
git commit -m "feat(api): users Express CRUD #CI"
slack-notify DONE users-express

# ---------------------------------------------------------------------
#  ■ Section-5  feat(api): reports suite                     <todo-key> reports-suite
# ---------------------------------------------------------------------
slack-notify START reports-suite
git checkout -b feature/reports-suite develop

# ① app/_schemas/reports.ts : reportQuerySchema
# ② app/api/bff/reports/route.ts : GET & proxy
# ③ ai-chat/src/routes/reports.ts : summary / chart / CSV
yarn lint --fix && yarn build
git add app/_schemas/reports.ts app/api/bff/reports ai-chat/src/routes/reports.ts
git commit -m "feat(api): reports suite #CI"
slack-notify DONE reports-suite

# ---------------------------------------------------------------------
#  ■ Section-6  feat(api): organizations suite               <todo-key> org-suite
# ---------------------------------------------------------------------
slack-notify START org-suite
git checkout -b feature/org-suite develop

# ① app/_schemas/organizations.ts （必要なら）
# ② app/api/bff/organizations/route.ts : GET stats / PUT update
# ③ ai-chat/src/routes/organizations.ts : マルチテナント実装
yarn lint --fix && yarn build
git add app/_schemas/organizations.ts app/api/bff/organizations ai-chat/src/routes/organizations.ts
git commit -m "feat(api): organizations suite #CI"
slack-notify DONE org-suite

# ---------------------------------------------------------------------
#  ■ Section-7  test(all): integration & e2e                 <todo-key> tests
# ---------------------------------------------------------------------
slack-notify START tests
git checkout -b feature/tests develop

# ① Jest + Supertest 統合テスト (Express)
# ② MSW / Playwright テスト (Next.js)
# ③ カバレッジ 80% 以上
yarn lint && yarn build && yarn test
git add app/tests ai-chat/tests
git commit -m "test: integration & e2e #CI"
slack-notify DONE tests

# =====================================================================
#  ■ FINALIZE
# ---------------------------------------------------------------------
slack-notify START finalize
git checkout develop
git merge --no-ff feature/dashboard-api \
                    feature/dashboard-express \
                    feature/users-bff \
                    feature/users-express \
                    feature/reports-suite \
                    feature/org-suite \
                    feature/tests

yarn format && yarn lint && yarn build
git commit -am "fix(lint): clear all errors #CI"
git push -u origin develop
gh pr create --base develop --fill
./scripts/slack-notify.sh "PR READY develop"
slack-notify DONE finalize
# =====================================================================
